<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PPO 算法学习与实战手册 | Alive-mk</title>
<link rel="shortcut icon" href="https://Alive-mk.github.io/favicon.ico?v=1770951170092">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://Alive-mk.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="PPO 算法学习与实战手册 | Alive-mk - Atom Feed" href="https://Alive-mk.github.io/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="PPO 算法学习与实战手册
第一阶段：三个核心角色（先验知识）
在 PPO 代码里，你会反复看到 Actor、Critic 和 Advantage，我们先把它们变成人话：
1. Actor（演员/策略）：就是“你”

它的工作：看到当前的情..." />
    <meta name="keywords" content="实习" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://Alive-mk.github.io">
  <img class="avatar" src="https://Alive-mk.github.io/images/avatar.png?v=1770951170092" alt="">
  </a>
  <h1 class="site-title">
    Alive-mk
  </h1>
  <p class="site-description">
    温故而知新
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          首页
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              PPO 算法学习与实战手册
            </h2>
            <div class="post-info">
              <span>
                2026-01-29
              </span>
              <span>
                48 min read
              </span>
              
                <a href="https://Alive-mk.github.io/tag/pt1Ejsp1Pa/" class="post-tag">
                  # 实习
                </a>
              
            </div>
            
            <div class="post-content-wrapper">
              <div class="post-content" v-pre>
                <h1 id="ppo-算法学习与实战手册">PPO 算法学习与实战手册</h1>
<h2 id="第一阶段三个核心角色先验知识">第一阶段：三个核心角色（先验知识）</h2>
<p>在 PPO 代码里，你会反复看到 <strong>Actor</strong>、<strong>Critic</strong> 和 <strong>Advantage</strong>，我们先把它们变成人话：</p>
<h3 id="1-actor演员策略就是你">1. Actor（演员/策略）：就是“你”</h3>
<ul>
<li><strong>它的工作</strong>：看到当前的情况（State，比如身体前倾 10 度），决定做一个动作（Action，比如重心后移）。</li>
<li><strong>它的输出</strong>：它不会只给一个动作，而是给出一堆动作的概率。比如：“我有 80% 的把握应该重心后移，20% 的把握应该蹲下”。</li>
<li><strong>目标</strong>：通过训练，让“正确动作”的概率越来越高。</li>
</ul>
<h3 id="2-critic评论家价值就是教练">2. Critic（评论家/价值）：就是“教练”</h3>
<ul>
<li><strong>它的工作</strong>：它不直接做动作，而是看着你的状态打分。它会预测：“照你现在这个姿势（State），我觉得你最后能得 90 分”。</li>
<li><strong>它的作用</strong>：它是你的基准线。如果最后你只得了 60 分，说明你表现得比教练预测的差；如果得了 100 分，说明好。</li>
</ul>
<h3 id="3-advantage优势就是惊喜感">3. Advantage（优势）：就是“惊喜感”</h3>
<p>这是 PPO 里最重要的数学概念，但逻辑很简单：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mtext>优势 (Advantage)</mtext><mo>=</mo><mtext>实际得分</mtext><mo>−</mo><mtext>教练预测的分数</mtext></mrow><annotation encoding="application/x-tex">\text{优势 (Advantage)} = \text{实际得分} - \text{教练预测的分数}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord cjk_fallback">优势</span><span class="mord"> (Advantage)</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord text"><span class="mord cjk_fallback">实际得分</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord text"><span class="mord cjk_fallback">教练预测的分数</span></span></span></span></span></span></p>
<p><strong>例子：</strong></p>
<ul>
<li>教练预测你能拿 80 分。</li>
<li>结果你超常发挥拿了 100 分。
<ul>
<li><strong>优势 = +20（正惊喜）</strong>。PPO 会说：“刚才那个动作太棒了，以后多做！”</li>
</ul>
</li>
<li>结果你摔倒了只拿 50 分。
<ul>
<li><strong>优势 = -30（负惊喜）</strong>。PPO 会说：“刚才那个动作千万别做了，赶紧忘掉。”</li>
</ul>
</li>
</ul>
<hr>
<h2 id="第二阶段ppo-到底解决了什么问题">第二阶段：PPO 到底解决了什么问题？</h2>
<p>在 PPO 出现之前，传统的强化学习有一个巨大的毛病：<strong>“学得太猛，容易走火入魔”</strong>。</p>
<p><strong>想象一下：</strong></p>
<ol>
<li>你做了一个动作，侥幸拿了满分。</li>
<li>传统的算法会说：“这个动作太神了！我要把它的概率从 10% 提到 99%！”</li>
<li>结果下一次你再试这个动作，因为环境稍微变了一点点，你摔了个大跟头。</li>
<li>但是因为你已经把概率提到了 99%，你很难再改回去了。模型彻底学坏了（Collapse）。</li>
</ol>
<p><strong>PPO 的核心思想就是：</strong> 咱们进步可以，但别步子迈太大。每次更新策略，只能在旧策略的基础上“微调”。</p>
<hr>
<h2 id="第三阶段ppo-的核心防暴走机制clipping">第三阶段：PPO 的核心“防暴走”机制（Clipping）</h2>
<p>这是论文里你必须掌握的唯一核心公式（公式 7）的白话版。</p>
<p>PPO 引入了一个**“比率” (Ratio)**，用来衡量你改了多少：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mtext>Ratio</mtext><mo>=</mo><mfrac><mtext>现在的动作概率</mtext><mtext>刚才的动作概率</mtext></mfrac></mrow><annotation encoding="application/x-tex">\text{Ratio} = \frac{\text{现在的动作概率}}{\text{刚才的动作概率}}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord text"><span class="mord">Ratio</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.04633em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord cjk_fallback">刚才的动作概率</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord cjk_fallback">现在的动作概率</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<ul>
<li>如果 Ratio = 1，说明没变。</li>
<li>如果 Ratio = 2，说明你把这个动作的概率翻倍了（步子迈太大了！）。</li>
</ul>
<p>PPO 给这个 Ratio 加了一把锁，叫 <strong>Clipping（截断）</strong>。通常把锁设定在 0.8 到 1.2 之间（论文里 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>ϵ</mi><mo>=</mo><mn>0.2</mn></mrow><annotation encoding="application/x-tex">\epsilon=0.2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">ϵ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">2</span></span></span></span> ）。</p>
<p><strong>它的逻辑是这样的（结合论文 Figure 1）：</strong></p>
<figure data-type="image" tabindex="1"><img src="https://Alive-mk.github.io/post-images/1769744407994.png" alt="" loading="lazy"></figure>
<ul>
<li>
<p><strong>如果你表现好（优势 &gt; 0）：</strong></p>
<ul>
<li>
<p>我想提高这个动作的概率。</p>
</li>
<li>
<p><strong>但是！</strong> 如果 Ratio 已经超过 1.2 了（提升超过 20%），我就不奖励你了。</p>
</li>
<li>
<blockquote>
<p><strong>潜台词</strong>：“行了行了，知道这个动作好，稍微提高点就行，别一下改太多，万一其实是运气好呢？”</p>
</blockquote>
</li>
</ul>
</li>
<li>
<p><strong>如果你表现差（优势 &lt; 0）：</strong></p>
<ul>
<li>
<p>我想降低这个动作的概率。</p>
</li>
<li>
<p><strong>但是！</strong> 如果 Ratio 已经低于 0.8 了（降低超过 20%），我就不惩罚你了。</p>
</li>
<li>
<blockquote>
<p><strong>潜台词</strong>：“虽然这次搞砸了，但也别因为一次失误就把这个动作彻底封杀，留点余地。”</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<p><strong>总结</strong>：这就是论文里那个看起来很可怕的 <code>min</code> 和 <code>clip</code> 公式的含义——<strong>不管奖励多诱人，每次修改策略绝不许超过 20% 的幅度</strong>。</p>
<hr>
<h2 id="第四阶段今天的代码任务流程algorithm-1">第四阶段：今天的代码任务流程（Algorithm 1）</h2>
<p>看论文第 5 页的 <strong>Algorithm 1</strong> ，我们要把它翻译成你的代码步骤：</p>
<ol>
<li><strong>去玩游戏（Sampling）</strong>：
<ul>
<li>用你现在的策略（Actor）去玩几局 CartPole。</li>
<li>记录下：你看到了什么（State），做了什么（Action），教练预测多少分（Value），实际得了多少分（Reward）。</li>
<li><em>注意：这时候不要更新模型，只管收集数据。</em></li>
</ul>
</li>
<li><strong>算算这一把玩得怎么样（Advantage Calculation）</strong>：
<ul>
<li>用刚才的记录，算出每一步的“优势”（Advantage）。</li>
<li>也就是：实际得分比教练预测的高了多少？</li>
</ul>
</li>
<li><strong>开始学习（Update / Optimization）</strong>：
<ul>
<li>这是最关键的一步。</li>
<li>拿出刚才的数据，计算 Loss（损失）。</li>
<li><strong>Loss = 动作好坏的损失 (用 Clip 锁住) + 教练预测准不准的损失 + 熵 (为了保持探索性)。</strong></li>
<li>让 PyTorch 帮你反向传播，更新网络参数。</li>
</ul>
</li>
<li><strong>重复</strong>：
<ul>
<li>现在的“新策略”变成了“旧策略”，回到第 1 步继续玩。</li>
</ul>
</li>
</ol>
<hr>
<h2 id="公式详解篇带数字的例子">公式详解篇：带数字的例子</h2>
<p>好的，既然要当做初学者来学，那我们就把数学符号完全拆解开，用“带数字的例子”来跑一遍这三个公式。请翻到论文的 <strong>第 3 页</strong> 和 <strong>第 5 页</strong>，对照着看。</p>
<h3 id="第一关比率公式-the-ratio">第一关：比率公式 (The Ratio)</h3>
<p><strong>论文位置</strong>：公式 (6) 上方</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>r</mi><mi>t</mi></msub><mo>(</mo><mi>θ</mi><mo>)</mo><mo>=</mo><mfrac><mrow><msub><mi>π</mi><mi>θ</mi></msub><mo>(</mo><msub><mi>a</mi><mi>t</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>s</mi><mi>t</mi></msub><mo>)</mo></mrow><mrow><msub><mi>π</mi><msub><mi>θ</mi><mrow><mi>o</mi><mi>l</mi><mi>d</mi></mrow></msub></msub><mo>(</mo><msub><mi>a</mi><mi>t</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>s</mi><mi>t</mi></msub><mo>)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">r_t(\theta) = \frac{\pi_{\theta}(a_t|s_t)}{\pi_{\theta_{old}}(a_t|s_t)}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.36886em;vertical-align:-0.94186em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999985em;"><span style="top:-2.55em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:-0.02778em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.25586em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.94186em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><strong>1. 拆解符号</strong></p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>π</mi><msub><mi>θ</mi><mrow><mi>o</mi><mi>l</mi><mi>d</mi></mrow></msub></msub><mo>(</mo><msub><mi>a</mi><mi>t</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>s</mi><mi>t</mi></msub><mo>)</mo></mrow><annotation encoding="application/x-tex">\pi_{\theta_{old}}(a_t|s_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.00586em;vertical-align:-0.25586em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999985em;"><span style="top:-2.55em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:-0.02778em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.25586em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>：<strong>旧策略</strong>。意思是：“在刚才那一局游戏里，我在这个状态下，选择做这个动作的概率是多少？”</li>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>π</mi><mi>θ</mi></msub><mo>(</mo><msub><mi>a</mi><mi>t</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>s</mi><mi>t</mi></msub><mo>)</mo></mrow><annotation encoding="application/x-tex">\pi_{\theta}(a_t|s_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>：<strong>新策略</strong>。意思是：“现在经过网络参数更新后，我在同样状态下，想做这个动作的概率变成了多少？”</li>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>r</mi><mi>t</mi></msub><mo>(</mo><mi>θ</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">r_t(\theta)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span></span></span></span>：<strong>变化倍数</strong>。</li>
</ul>
<p><strong>2. 带数字的例子</strong></p>
<p>假设我们在玩 CartPole（平衡杆）。</p>
<ul>
<li><strong>状态</strong>：杆子快要向左倒了。</li>
<li><strong>动作</strong>：向左推车（这是正确的救命动作）。</li>
<li><strong>场景 A：刚开始训练</strong>
<ul>
<li>旧策略说：我有 0.5 的概率向左推。</li>
<li>新策略（稍微学了一点后）说：我觉得应该有 0.6 的概率向左推。</li>
<li><strong>计算 Ratio</strong>：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>r</mi><mi>t</mi></msub><mo>=</mo><mfrac><mn>0.6</mn><mn>0.5</mn></mfrac><mo>=</mo><mn>1.2</mn></mrow><annotation encoding="application/x-tex">r_t = \frac{0.6}{0.5} = 1.2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mord mtight">.</span><span class="mord mtight">5</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mord mtight">.</span><span class="mord mtight">6</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">2</span></span></span></span>。</li>
<li><strong>人话</strong>：新策略比旧策略自信了 1.2 倍。</li>
</ul>
</li>
<li><strong>场景 B：步子迈太大了</strong>
<ul>
<li>旧策略说：0.5。</li>
<li>新策略突然激进地说：0.95。</li>
<li><strong>计算 Ratio</strong>：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>r</mi><mi>t</mi></msub><mo>=</mo><mfrac><mn>0.95</mn><mn>0.5</mn></mfrac><mo>=</mo><mn>1.9</mn></mrow><annotation encoding="application/x-tex">r_t = \frac{0.95}{0.5} = 1.9</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mord mtight">.</span><span class="mord mtight">5</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mord mtight">.</span><span class="mord mtight">9</span><span class="mord mtight">5</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">9</span></span></span></span>。</li>
<li><strong>人话</strong>：变动幅度接近 2 倍！这就是 PPO 要警惕的“危险信号”。</li>
</ul>
</li>
</ul>
<h3 id="第二关截断目标函数-clipped-objective-核心中的核心">第二关：截断目标函数 (Clipped Objective) —— 核心中的核心</h3>
<p><strong>论文位置</strong>：公式 (7)</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>L</mi><mrow><mi>C</mi><mi>L</mi><mi>I</mi><mi>P</mi></mrow></msup><mo>(</mo><mi>θ</mi><mo>)</mo><mo>=</mo><msub><mover accent="true"><mi mathvariant="double-struck">E</mi><mo>^</mo></mover><mi>t</mi></msub><mrow><mo fence="true">[</mo><mi>min</mi><mo>⁡</mo><mo>(</mo><msub><mi>r</mi><mi>t</mi></msub><mo>(</mo><mi>θ</mi><mo>)</mo><msub><mover accent="true"><mi>A</mi><mo>^</mo></mover><mi>t</mi></msub><mo separator="true">,</mo><mtext>clip</mtext><mo>(</mo><msub><mi>r</mi><mi>t</mi></msub><mo>(</mo><mi>θ</mi><mo>)</mo><mo separator="true">,</mo><mn>1</mn><mo>−</mo><mi>ϵ</mi><mo separator="true">,</mo><mn>1</mn><mo>+</mo><mi>ϵ</mi><mo>)</mo><msub><mover accent="true"><mi>A</mi><mo>^</mo></mover><mi>t</mi></msub><mo>)</mo><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">L^{CLIP}(\theta) = \hat{\mathbb{E}}_t \left[ \min(r_t(\theta)\hat{A}_t, \text{clip}(r_t(\theta), 1-\epsilon, 1+\epsilon)\hat{A}_t) \right]
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1413309999999999em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.07153em;">C</span><span class="mord mathdefault mtight">L</span><span class="mord mathdefault mtight" style="margin-right:0.07847em;">I</span><span class="mord mathdefault mtight" style="margin-right:0.13889em;">P</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.80002em;vertical-align:-0.65002em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9523299999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span></span></span><span style="top:-3.25789em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.16666em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">[</span></span><span class="mop">min</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9467699999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.11110999999999999em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">clip</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">ϵ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">ϵ</span><span class="mclose">)</span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9467699999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.11110999999999999em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">]</span></span></span></span></span></span></span></p>
<p>设定 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>ϵ</mi><mo>=</mo><mn>0.2</mn></mrow><annotation encoding="application/x-tex">\epsilon = 0.2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">ϵ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">2</span></span></span></span>（这是论文推荐的黄金参数），意味着我们允许的波动范围是 <strong>0.8 到 1.2</strong>。</p>
<p>我们分两种情况来模拟，看看这个 <code>min</code> 函数到底在选什么。</p>
<p><strong>情况 1：你做对了 (Advantage <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mover accent="true"><mi>A</mi><mo>^</mo></mover><mi>t</mi></msub><mo>=</mo><mo>+</mo><mn>1.0</mn></mrow><annotation encoding="application/x-tex">\hat{A}_t = +1.0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0967699999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9467699999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.11110999999999999em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">+</span><span class="mord">1</span><span class="mord">.</span><span class="mord">0</span></span></span></span>)</strong></p>
<p>你向左推车，杆子平衡了，教练很高兴，给了一个 +1.0 的正优势。</p>
<ul>
<li><strong>剧本 A：微调（安全）</strong>
<ul>
<li>Ratio (<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>r</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">r_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>) = 1.1 (从 0.5 提升到 0.55)。</li>
<li><strong>左边 (无截断)</strong>：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1.1</mn><mo>×</mo><mn>1.0</mn><mo>=</mo><mn>1.1</mn></mrow><annotation encoding="application/x-tex">1.1 \times 1.0 = 1.1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">1</span></span></span></span></li>
<li><strong>右边 (截断)</strong>：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mtext>clip</mtext><mo>(</mo><mn>1.1</mn><mo separator="true">,</mo><mn>0.8</mn><mo separator="true">,</mo><mn>1.2</mn><mo>)</mo><mo>×</mo><mn>1.0</mn><mo>=</mo><mn>1.1</mn><mo>×</mo><mn>1.0</mn><mo>=</mo><mn>1.1</mn></mrow><annotation encoding="application/x-tex">\text{clip}(1.1, 0.8, 1.2) \times 1.0 = 1.1 \times 1.0 = 1.1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">clip</span></span><span class="mopen">(</span><span class="mord">1</span><span class="mord">.</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">8</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">2</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">1</span></span></span></span></li>
<li><strong>结果</strong>：<code>min(1.1, 1.1) = 1.1</code>。</li>
<li><strong>结论</strong>：你在安全范围内提升，<strong>通过</strong>。</li>
</ul>
</li>
<li><strong>剧本 B：暴走（危险）</strong>
<ul>
<li>Ratio (<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>r</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">r_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>) = 1.5 (从 0.5 飙升到 0.75，太快了！)。</li>
<li><strong>左边 (无截断)</strong>：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1.5</mn><mo>×</mo><mn>1.0</mn><mo>=</mo><mn>1.5</mn></mrow><annotation encoding="application/x-tex">1.5 \times 1.0 = 1.5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">5</span></span></span></span> (传统的 PG 会用这个值，导致更新过猛)。</li>
<li><strong>右边 (截断)</strong>：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mtext>clip</mtext><mo>(</mo><mn>1.5</mn><mo separator="true">,</mo><mn>0.8</mn><mo separator="true">,</mo><mn>1.2</mn><mo>)</mo></mrow><annotation encoding="application/x-tex">\text{clip}(1.5, 0.8, 1.2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">clip</span></span><span class="mopen">(</span><span class="mord">1</span><span class="mord">.</span><span class="mord">5</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">8</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">2</span><span class="mclose">)</span></span></span></span>。因为 1.5 超过了 1.2，所以被强制按在 1.2。结果是 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1.2</mn><mo>×</mo><mn>1.0</mn><mo>=</mo><mn>1.2</mn></mrow><annotation encoding="application/x-tex">1.2 \times 1.0 = 1.2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">2</span></span></span></span>。</li>
<li><strong>结果</strong>：<code>min(1.5, 1.2) = 1.2</code>。</li>
<li><strong>结论</strong>：虽然你想奖励 1.5 倍，但 PPO 说“不行，最多给你算 1.2 的功劳”。多出来的部分被“切掉”了。</li>
</ul>
</li>
</ul>
<p><strong>情况 2：你做错了 (Advantage <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mover accent="true"><mi>A</mi><mo>^</mo></mover><mi>t</mi></msub><mo>=</mo><mo>−</mo><mn>1.0</mn></mrow><annotation encoding="application/x-tex">\hat{A}_t = -1.0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0967699999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9467699999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.11110999999999999em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord">1</span><span class="mord">.</span><span class="mord">0</span></span></span></span>)</strong></p>
<p>你向右推车，杆子倒了，教练很生气，给了一个 -1.0 的负优势。我们希望 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>r</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">r_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 变小（减少概率）。</p>
<ul>
<li><strong>剧本 C：微调（安全）</strong>
<ul>
<li>Ratio (<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>r</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">r_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>) = 0.9 (概率稍微降低了一点)。</li>
<li><strong>左边</strong>：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>0.9</mn><mo>×</mo><mo>(</mo><mo>−</mo><mn>1.0</mn><mo>)</mo><mo>=</mo><mo>−</mo><mn>0.9</mn></mrow><annotation encoding="application/x-tex">0.9 \times (-1.0) = -0.9</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">9</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">−</span><span class="mord">1</span><span class="mord">.</span><span class="mord">0</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord">0</span><span class="mord">.</span><span class="mord">9</span></span></span></span></li>
<li><strong>右边</strong>：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mtext>clip</mtext><mo>(</mo><mn>0.9</mn><mo separator="true">,</mo><mn>0.8</mn><mo separator="true">,</mo><mn>1.2</mn><mo>)</mo><mo>×</mo><mo>(</mo><mo>−</mo><mn>1.0</mn><mo>)</mo><mo>=</mo><mn>0.9</mn><mo>×</mo><mo>(</mo><mo>−</mo><mn>1.0</mn><mo>)</mo><mo>=</mo><mo>−</mo><mn>0.9</mn></mrow><annotation encoding="application/x-tex">\text{clip}(0.9, 0.8, 1.2) \times (-1.0) = 0.9 \times (-1.0) = -0.9</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">clip</span></span><span class="mopen">(</span><span class="mord">0</span><span class="mord">.</span><span class="mord">9</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">8</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">2</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">−</span><span class="mord">1</span><span class="mord">.</span><span class="mord">0</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">9</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">−</span><span class="mord">1</span><span class="mord">.</span><span class="mord">0</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord">0</span><span class="mord">.</span><span class="mord">9</span></span></span></span></li>
<li><strong>结果</strong>：<code>min(-0.9, -0.9) = -0.9</code>。</li>
<li><strong>结论</strong>：正常惩罚。</li>
</ul>
</li>
<li><strong>剧本 D：崩塌（危险）</strong>
<ul>
<li>Ratio (<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>r</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">r_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>) = 0.05 (你被吓破胆了，直接把概率降到了 0)。</li>
<li><strong>左边</strong>：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>0.05</mn><mo>×</mo><mo>(</mo><mo>−</mo><mn>1.0</mn><mo>)</mo><mo>=</mo><mo>−</mo><mn>0.05</mn></mrow><annotation encoding="application/x-tex">0.05 \times (-1.0) = -0.05</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">−</span><span class="mord">1</span><span class="mord">.</span><span class="mord">0</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">5</span></span></span></span> (注意：负得少，惩罚其实小？不，这里看梯度方向。关键是看截断)。</li>
<li><strong>右边</strong>：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mtext>clip</mtext><mo>(</mo><mn>0.05</mn><mo separator="true">,</mo><mn>0.8</mn><mo separator="true">,</mo><mn>1.2</mn><mo>)</mo></mrow><annotation encoding="application/x-tex">\text{clip}(0.05, 0.8, 1.2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">clip</span></span><span class="mopen">(</span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">5</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">8</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">2</span><span class="mclose">)</span></span></span></span>。0.05 远小于 0.8，被强制锁定在 0.8。结果是 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>0.8</mn><mo>×</mo><mo>(</mo><mo>−</mo><mn>1.0</mn><mo>)</mo><mo>=</mo><mo>−</mo><mn>0.8</mn></mrow><annotation encoding="application/x-tex">0.8 \times (-1.0) = -0.8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">−</span><span class="mord">1</span><span class="mord">.</span><span class="mord">0</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord">0</span><span class="mord">.</span><span class="mord">8</span></span></span></span>。</li>
<li><strong>结果</strong>：<code>min(-0.05, -0.8)</code>。哪个更小？是 -0.8。</li>
<li><strong>重点解释</strong>：这里看起来有点反直觉。其实在代码里，我们是<strong>最大化</strong>这个目标函数。
<ul>
<li>如果没有 clip，模型可能会把概率压到极低（<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>r</mi><mi>t</mi></msub><mo>→</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">r_t \to 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>），导致梯度极不稳定。</li>
<li>有了 clip，当 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>r</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">r_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 低于 0.8 时，目标函数的值就固定在 -0.8 了。<strong>重点是：函数变平了，导数（梯度）变成了 0！</strong></li>
</ul>
</li>
<li><strong>结论</strong>：一旦你修改幅度过大（超过边界），梯度就消失了，<strong>网络停止更新这个参数</strong>。这就在物理上阻止了策略继续“恶化”。</li>
</ul>
</li>
</ul>
<h3 id="第三关总损失函数-total-loss">第三关：总损失函数 (Total Loss)</h3>
<p><strong>论文位置</strong>：公式 (9)</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msubsup><mi>L</mi><mi>t</mi><mrow><mi>C</mi><mi>L</mi><mi>I</mi><mi>P</mi><mo>+</mo><mi>V</mi><mi>F</mi><mo>+</mo><mi>S</mi></mrow></msubsup><mo>(</mo><mi>θ</mi><mo>)</mo><mo>=</mo><msub><mover accent="true"><mi mathvariant="double-struck">E</mi><mo>^</mo></mover><mi>t</mi></msub><mo>[</mo><msubsup><mi>L</mi><mi>t</mi><mrow><mi>C</mi><mi>L</mi><mi>I</mi><mi>P</mi></mrow></msubsup><mo>(</mo><mi>θ</mi><mo>)</mo><mo>−</mo><msub><mi>c</mi><mn>1</mn></msub><msubsup><mi>L</mi><mi>t</mi><mrow><mi>V</mi><mi>F</mi></mrow></msubsup><mo>(</mo><mi>θ</mi><mo>)</mo><mo>+</mo><msub><mi>c</mi><mn>2</mn></msub><mi>S</mi><mo>[</mo><msub><mi>π</mi><mi>θ</mi></msub><mo>]</mo><mo>(</mo><msub><mi>s</mi><mi>t</mi></msub><mo>)</mo><mo>]</mo></mrow><annotation encoding="application/x-tex">L_t^{CLIP+VF+S}(\theta) = \hat{\mathbb{E}}_t [ L_t^{CLIP}(\theta) - c_1 L_t^{VF}(\theta) + c_2 S[\pi_\theta](s_t) ]
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1413309999999999em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913309999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.07153em;">C</span><span class="mord mathdefault mtight">L</span><span class="mord mathdefault mtight" style="margin-right:0.07847em;">I</span><span class="mord mathdefault mtight" style="margin-right:0.13889em;">P</span><span class="mbin mtight">+</span><span class="mord mathdefault mtight" style="margin-right:0.22222em;">V</span><span class="mord mathdefault mtight" style="margin-right:0.13889em;">F</span><span class="mbin mtight">+</span><span class="mord mathdefault mtight" style="margin-right:0.05764em;">S</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.20233em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9523299999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span></span></span><span style="top:-3.25789em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.16666em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">[</span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913309999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.07153em;">C</span><span class="mord mathdefault mtight">L</span><span class="mord mathdefault mtight" style="margin-right:0.07847em;">I</span><span class="mord mathdefault mtight" style="margin-right:0.13889em;">P</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1413309999999999em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913309999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.22222em;">V</span><span class="mord mathdefault mtight" style="margin-right:0.13889em;">F</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mopen">[</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">]</span></span></span></span></span></p>
<p>这就好比你在公司上班，你的 <strong>KPI (总分)</strong> 由三部分组成：</p>
<ol>
<li><strong>业务提成 (<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>L</mi><mrow><mi>C</mi><mi>L</mi><mi>I</mi><mi>P</mi></mrow></msup></mrow><annotation encoding="application/x-tex">L^{CLIP}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.07153em;">C</span><span class="mord mathdefault mtight">L</span><span class="mord mathdefault mtight" style="margin-right:0.07847em;">I</span><span class="mord mathdefault mtight" style="margin-right:0.13889em;">P</span></span></span></span></span></span></span></span></span></span></span></span>)</strong>：
<ul>
<li><strong>目标</strong>：越高越好。</li>
<li>这就是我们刚才算的那个带截断的得分。</li>
<li><strong>作用</strong>：让你学会在游戏里拿高分。</li>
</ul>
</li>
<li><strong>预测准确率考核 (<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>−</mo><msub><mi>c</mi><mn>1</mn></msub><msup><mi>L</mi><mrow><mi>V</mi><mi>F</mi></mrow></msup></mrow><annotation encoding="application/x-tex">-c_1 L^{VF}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.991331em;vertical-align:-0.15em;"></span><span class="mord">−</span><span class="mord"><span class="mord mathdefault">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.22222em;">V</span><span class="mord mathdefault mtight" style="margin-right:0.13889em;">F</span></span></span></span></span></span></span></span></span></span></span></span>)</strong>：
<ul>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>L</mi><mrow><mi>V</mi><mi>F</mi></mrow></msup></mrow><annotation encoding="application/x-tex">L^{VF}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.22222em;">V</span><span class="mord mathdefault mtight" style="margin-right:0.13889em;">F</span></span></span></span></span></span></span></span></span></span></span></span> 是你（Critic）预测分数的<strong>误差</strong>。</li>
<li>比如你预测这局能拿 100 分，结果只拿了 50 分，误差是 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>(</mo><mn>100</mn><mo>−</mo><mn>50</mn><msup><mo>)</mo><mn>2</mn></msup><mo>=</mo><mn>2500</mn></mrow><annotation encoding="application/x-tex">(100-50)^2 = 2500</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord">5</span><span class="mord">0</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mord">5</span><span class="mord">0</span><span class="mord">0</span></span></span></span>。</li>
<li>公式里用了减号。意思是：误差越大，KPI 越低。</li>
<li><strong>目标</strong>：让误差越小越好。</li>
<li><strong>作用</strong>：让 Critic 对局势的判断越来越准。如果 Critic 瞎指挥，Actor 根本学不好。</li>
</ul>
</li>
<li><strong>创新奖励 (<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>+</mo><msub><mi>c</mi><mn>2</mn></msub><mi>S</mi></mrow><annotation encoding="application/x-tex">+c_2 S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord">+</span><span class="mord"><span class="mord mathdefault">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span></span></span></span>)</strong>：
<ul>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span></span></span></span> (Entropy) 是熵。</li>
<li><strong>例子</strong>：
<ul>
<li>如果你只会一直向左推（概率 1.0），熵 = 0。你变成了机器，毫无创意。</li>
<li>如果你有 50% 向左，50% 向右，熵最大。你在尝试不同可能。</li>
</ul>
</li>
<li><strong>目标</strong>：我们希望保留一点熵（加分项）。</li>
<li><strong>作用</strong>：防止你“死记硬背”。比如刚开始运气好，一直向左赢了一次，如果没有熵奖励，模型可能会立刻把向左的概率锁死到 100%，再也不试向右了。熵奖励逼着模型说：“别急着下定论，再多试几次别的路。”</li>
</ul>
</li>
</ol>
<hr>
<h2 id="优势函数-gae-详解">优势函数 (GAE) 详解</h2>
<p>没问题，我们把<strong>优势计算 (Advantage Calculation)</strong> 单独拎出来讲。这是 PPO 代码实现中最容易写错，但也是最精彩的部分。</p>
<p>在论文的公式 (11) 和 (12) 中，作者使用了 <strong>GAE (Generalized Advantage Estimation)</strong>。</p>
<p>我们将分三步来理解：<strong>单步惊喜 (<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>δ</mi></mrow><annotation encoding="application/x-tex">\delta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03785em;">δ</span></span></span></span>)</strong> -&gt; <strong>多步连锁惊喜 (GAE)</strong> -&gt; <strong>手动算一遍（例子）</strong>。</p>
<h3 id="第一步理解单步惊喜-delta_t-td-error">第一步：理解“单步惊喜” (<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>δ</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">\delta_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03785em;">δ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>) —— TD Error</h3>
<p><strong>对应论文公式 (12)：</strong></p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>δ</mi><mi>t</mi></msub><mo>=</mo><msub><mi>r</mi><mi>t</mi></msub><mo>+</mo><mi>γ</mi><mi>V</mi><mo>(</mo><msub><mi>s</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>)</mo><mo>−</mo><mi>V</mi><mo>(</mo><msub><mi>s</mi><mi>t</mi></msub><mo>)</mo></mrow><annotation encoding="application/x-tex">\delta_t = r_t + \gamma V(s_{t+1}) - V(s_t)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03785em;">δ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.73333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.05556em;">γ</span><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.301108em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p>还记得那个“教练” (Critic/Value Function) 吗？</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>V</mi><mo>(</mo><msub><mi>s</mi><mi>t</mi></msub><mo>)</mo></mrow><annotation encoding="application/x-tex">V(s_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>：教练预测你在当前状态能拿多少分（<strong>预期</strong>）。</li>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>r</mi><mi>t</mi></msub><mo>+</mo><mi>γ</mi><mi>V</mi><mo>(</mo><msub><mi>s</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>)</mo></mrow><annotation encoding="application/x-tex">r_t + \gamma V(s_{t+1})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.73333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.05556em;">γ</span><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.301108em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>：你实际拿到的眼前奖励 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>r</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">r_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，加上你到了下一个状态后教练依然觉得你值多少分（<strong>现实</strong>）。</li>
</ul>
<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>δ</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">\delta_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03785em;">δ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> (Delta) 就是“现实 - 预期”的差值。</p>
<p><strong>举个例子：</strong></p>
<p>假设你在玩“吃金币”游戏。</p>
<ul>
<li><strong>预期</strong>：教练看你在 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathdefault">t</span></span></span></span> 时刻的位置，说：“我觉得你这局总共能拿 <strong>10分</strong>” (<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>V</mi><mo>(</mo><msub><mi>s</mi><mi>t</mi></msub><mo>)</mo><mo>=</mo><mn>10</mn></mrow><annotation encoding="application/x-tex">V(s_t)=10</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">0</span></span></span></span>)。</li>
<li><strong>现实</strong>：
<ol>
<li>你往前走了一步，吃到了一个金币，奖励 <strong>+1</strong> (<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>r</mi><mi>t</mi></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">r_t=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>)。</li>
<li>教练看你到了 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">t+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69841em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> 时刻的新位置，说：“这里位置不错，后面应该还能拿 <strong>9.5分</strong>” (<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>V</mi><mo>(</mo><msub><mi>s</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>)</mo><mo>=</mo><mn>9.5</mn></mrow><annotation encoding="application/x-tex">V(s_{t+1})=9.5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.301108em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">9</span><span class="mord">.</span><span class="mord">5</span></span></span></span>)。</li>
<li>假设折扣因子 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>γ</mi><mo>=</mo><mn>1.0</mn></mrow><annotation encoding="application/x-tex">\gamma=1.0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.05556em;">γ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">0</span></span></span></span> (为了简单)。</li>
<li>你的“现实价值” = <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mo>+</mo><mn>9.5</mn><mo>=</mo><mn>10.5</mn></mrow><annotation encoding="application/x-tex">1 + 9.5 = 10.5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">9</span><span class="mord">.</span><span class="mord">5</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">.</span><span class="mord">5</span></span></span></span>。</li>
</ol>
</li>
<li><strong>计算 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>δ</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">\delta_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03785em;">δ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></strong>：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>10.5</mn><mo>−</mo><mn>10</mn><mo>=</mo><mrow><mo>+</mo><mn mathvariant="bold">0.5</mn></mrow></mrow><annotation encoding="application/x-tex">10.5 - 10 = \mathbf{+0.5}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">.</span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">+</span><span class="mord mathbf">0</span><span class="mord mathbf">.</span><span class="mord mathbf">5</span></span></span></span></span>。</li>
<li><strong>含义</strong>：这一步你比教练预期的表现好了 0.5 分。这就是<strong>单步优势</strong>。</li>
</ul>
<h3 id="第二步理解多步连锁-gae-lambda-的魔法">第二步：理解“多步连锁” (GAE) —— <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>λ</mi></mrow><annotation encoding="application/x-tex">\lambda</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">λ</span></span></span></span> 的魔法</h3>
<p><strong>对应论文公式 (11)：</strong></p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mover accent="true"><mi>A</mi><mo>^</mo></mover><mi>t</mi></msub><mo>=</mo><msub><mi>δ</mi><mi>t</mi></msub><mo>+</mo><mo>(</mo><mi>γ</mi><mi>λ</mi><mo>)</mo><msub><mi>δ</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>+</mo><mo>(</mo><mi>γ</mi><mi>λ</mi><msup><mo>)</mo><mn>2</mn></msup><msub><mi>δ</mi><mrow><mi>t</mi><mo>+</mo><mn>2</mn></mrow></msub><mo>+</mo><mo>…</mo></mrow><annotation encoding="application/x-tex">\hat{A}_t = \delta_t + (\gamma \lambda) \delta_{t+1} + (\gamma \lambda)^2 \delta_{t+2} + \dots
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0967699999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9467699999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.11110999999999999em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03785em;">δ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.05556em;">γ</span><span class="mord mathdefault">λ</span><span class="mclose">)</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03785em;">δ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.301108em;"><span style="top:-2.5500000000000003em;margin-left:-0.03785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1141079999999999em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.05556em;">γ</span><span class="mord mathdefault">λ</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03785em;">δ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.301108em;"><span style="top:-2.5500000000000003em;margin-left:-0.03785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.12em;vertical-align:0em;"></span><span class="minner">…</span></span></span></span></span></p>
<p><strong>为什么要这么复杂？</strong></p>
<p>这就好比你下棋。</p>
<p>第 1 步你走了一招妙手（<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>δ</mi><mn>1</mn></msub><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\delta_1 &gt; 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03785em;">δ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>），但这招妙手不仅让你现在爽了，它还为你第 2 步、第 3 步的进攻奠定了基础。</p>
<p>所以，<strong>第 1 步的优势，不仅包含第 1 步的惊喜 (<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>δ</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\delta_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03785em;">δ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>)，还要加上第 2 步惊喜的一定比例 (<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>γ</mi><mi>λ</mi><msub><mi>δ</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">\gamma\lambda \delta_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.05556em;">γ</span><span class="mord mathdefault">λ</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03785em;">δ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>)，甚至第 3 步...</strong></p>
<p><strong>参数 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>λ</mi></mrow><annotation encoding="application/x-tex">\lambda</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">λ</span></span></span></span> (Lambda) 的作用：</strong></p>
<p>它是一个 0 到 1 之间的衰减系数（论文里设为 0.95）。</p>
<p>它的作用是问：<strong>“未来的惊喜，算多少功劳给当下这一步？”</strong></p>
<ul>
<li>如果 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>λ</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\lambda = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">λ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mover accent="true"><mi>A</mi><mo>^</mo></mover><mi>t</mi></msub><mo>=</mo><msub><mi>δ</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">\hat{A}_t = \delta_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0967699999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9467699999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.11110999999999999em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03785em;">δ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>。只看眼前这一步，完全不管未来。目光短浅。</li>
<li>如果 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>λ</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\lambda = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">λ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>：未来的所有惊喜都 100% 算在这一步头上。目光太长远，容易受运气干扰（方差大）。</li>
<li><strong>PPO 取 0.95</strong>：折中。现在的动作对未来有影响，但影响随着时间推移越来越小。</li>
</ul>
<h3 id="第三步手动算一遍代码逻辑">第三步：手动算一遍（代码逻辑）</h3>
<p>这是你在写代码时最需要搞懂的逻辑。因为公式里有 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">t+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69841em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>，所以我们在代码里通常是<strong>倒着算 (Backwards)</strong> 的。</p>
<p><strong>场景假设：</strong></p>
<p>游戏一共玩了 3 步就结束了。</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>γ</mi></mrow><annotation encoding="application/x-tex">\gamma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.05556em;">γ</span></span></span></span> (折扣) = 1.0</li>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>λ</mi></mrow><annotation encoding="application/x-tex">\lambda</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">λ</span></span></span></span> (衰减) = 0.5 (为了方便口算)</li>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>δ</mi></mrow><annotation encoding="application/x-tex">\delta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03785em;">δ</span></span></span></span> (算出来的单步惊喜)：
<ul>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>t</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">t=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>: <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>δ</mi><mn>0</mn></msub><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">\delta_0 = 2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03785em;">δ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span></span></span></span> (这步走得好)</li>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>t</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">t=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>: <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>δ</mi><mn>1</mn></msub><mo>=</mo><mo>−</mo><mn>4</mn></mrow><annotation encoding="application/x-tex">\delta_1 = -4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03785em;">δ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord">4</span></span></span></span> (这步走臭了)</li>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>t</mi><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">t=2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span></span></span></span>: <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>δ</mi><mn>2</mn></msub><mo>=</mo><mn>6</mn></mrow><annotation encoding="application/x-tex">\delta_2 = 6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03785em;">δ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">6</span></span></span></span> (最后一步绝杀)</li>
</ul>
</li>
</ul>
<p>我们来算最终的优势 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mover accent="true"><mi>A</mi><mo>^</mo></mover></mrow><annotation encoding="application/x-tex">\hat{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9467699999999999em;vertical-align:0em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9467699999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.11110999999999999em;">^</span></span></span></span></span></span></span></span></span>：</p>
<ol>
<li><strong>先算最后一步 (t=2)</strong>
<ul>
<li>公式：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mover accent="true"><mi>A</mi><mo>^</mo></mover><mn>2</mn></msub><mo>=</mo><msub><mi>δ</mi><mn>2</mn></msub><mo>+</mo><mo>(</mo><mi>γ</mi><mi>λ</mi><mo>)</mo><mo>×</mo><mtext>下一刻的优势</mtext></mrow><annotation encoding="application/x-tex">\hat{A}_2 = \delta_2 + (\gamma \lambda) \times \text{下一刻的优势}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0967699999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9467699999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.11110999999999999em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03785em;">δ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.05556em;">γ</span><span class="mord mathdefault">λ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord text"><span class="mord cjk_fallback">下一刻的优势</span></span></span></span></span></li>
<li>因为游戏结束了，下一刻优势是 0。</li>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mover accent="true"><mi>A</mi><mo>^</mo></mover><mn>2</mn></msub><mo>=</mo><mn>6</mn></mrow><annotation encoding="application/x-tex">\hat{A}_2 = 6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0967699999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9467699999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.11110999999999999em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">6</span></span></span></span></li>
<li><strong>解读</strong>：最后一步的优势就是它自己的单步惊喜。</li>
</ul>
</li>
<li><strong>倒推算倒数第二步 (t=1)</strong>
<ul>
<li>公式：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mover accent="true"><mi>A</mi><mo>^</mo></mover><mn>1</mn></msub><mo>=</mo><msub><mi>δ</mi><mn>1</mn></msub><mo>+</mo><mo>(</mo><mi>γ</mi><mi>λ</mi><mo>)</mo><mo>×</mo><msub><mover accent="true"><mi>A</mi><mo>^</mo></mover><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">\hat{A}_1 = \delta_1 + (\gamma \lambda) \times \hat{A}_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0967699999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9467699999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.11110999999999999em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03785em;">δ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.05556em;">γ</span><span class="mord mathdefault">λ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.0967699999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9467699999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.11110999999999999em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></li>
<li>计算：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mover accent="true"><mi>A</mi><mo>^</mo></mover><mn>1</mn></msub><mo>=</mo><mo>−</mo><mn>4</mn><mo>+</mo><mo>(</mo><mn>1.0</mn><mo>×</mo><mn>0.5</mn><mo>)</mo><mo>×</mo><mn>6</mn></mrow><annotation encoding="application/x-tex">\hat{A}_1 = -4 + (1.0 \times 0.5) \times 6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0967699999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9467699999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.11110999999999999em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mord">.</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">5</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">6</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mover accent="true"><mi>A</mi><mo>^</mo></mover><mn>1</mn></msub><mo>=</mo><mo>−</mo><mn>4</mn><mo>+</mo><mn>3</mn><mo>=</mo><mrow><mo>−</mo><mn mathvariant="bold">1</mn></mrow></mrow><annotation encoding="application/x-tex">\hat{A}_1 = -4 + 3 = \mathbf{-1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0967699999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9467699999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.11110999999999999em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">−</span><span class="mord mathbf">1</span></span></span></span></span></li>
<li><strong>解读</strong>：虽然第 1 步走臭了（单步 -4），但因为它导致了最后一步的绝杀（+6），所以综合来看，这一步也没那么烂，只是 -1。这就是 GAE 的威力：能看到长远影响。</li>
</ul>
</li>
<li><strong>倒推算第一步 (t=0)</strong>
<ul>
<li>公式：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mover accent="true"><mi>A</mi><mo>^</mo></mover><mn>0</mn></msub><mo>=</mo><msub><mi>δ</mi><mn>0</mn></msub><mo>+</mo><mo>(</mo><mi>γ</mi><mi>λ</mi><mo>)</mo><mo>×</mo><msub><mover accent="true"><mi>A</mi><mo>^</mo></mover><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\hat{A}_0 = \delta_0 + (\gamma \lambda) \times \hat{A}_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0967699999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9467699999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.11110999999999999em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03785em;">δ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.05556em;">γ</span><span class="mord mathdefault">λ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.0967699999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9467699999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.11110999999999999em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></li>
<li>计算：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mover accent="true"><mi>A</mi><mo>^</mo></mover><mn>0</mn></msub><mo>=</mo><mn>2</mn><mo>+</mo><mo>(</mo><mn>1.0</mn><mo>×</mo><mn>0.5</mn><mo>)</mo><mo>×</mo><mo>(</mo><mo>−</mo><mn>1</mn><mo>)</mo></mrow><annotation encoding="application/x-tex">\hat{A}_0 = 2 + (1.0 \times 0.5) \times (-1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0967699999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9467699999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.11110999999999999em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mord">.</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">5</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">−</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mover accent="true"><mi>A</mi><mo>^</mo></mover><mn>0</mn></msub><mo>=</mo><mn>2</mn><mo>−</mo><mn>0.5</mn><mo>=</mo><mn mathvariant="bold">1.5</mn></mrow><annotation encoding="application/x-tex">\hat{A}_0 = 2 - 0.5 = \mathbf{1.5}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0967699999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9467699999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.11110999999999999em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">5</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">1</span><span class="mord mathbf">.</span><span class="mord mathbf">5</span></span></span></span></span></li>
<li><strong>解读</strong>：第一步本来很好（+2），但因为它把局面引向了那个有点臭的第二步（-1），所以它的功劳被打了一点折扣，变成了 1.5。</li>
</ul>
</li>
</ol>
<p><strong>总结</strong></p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>δ</mi></mrow><annotation encoding="application/x-tex">\delta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03785em;">δ</span></span></span></span> (Delta)：是<strong>当下的</strong>现实与预期的落差。</li>
<li>GAE (<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mover accent="true"><mi>A</mi><mo>^</mo></mover></mrow><annotation encoding="application/x-tex">\hat{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9467699999999999em;vertical-align:0em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9467699999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.11110999999999999em;">^</span></span></span></span></span></span></span></span></span>)：是<strong>当下 + 未来</strong>所有落差的加权总和。</li>
<li><strong>计算技巧</strong>：必须<strong>倒着算</strong>，因为今天的优势包含了一部分明天的优势。</li>
</ul>
<hr>
<h2 id="代码切片详解输入-处理-输出">代码切片详解：输入-&gt;处理-&gt;输出</h2>
<p>没问题。这种“代码 + 数据流”结合的讲解方式是最透彻的。</p>
<p>我们把代码切成三个具体的<strong>切片 (Snippets)</strong>，针对每个切片，我都会按照 <strong>【输入长这样】 -&gt; 【代码逐行解析】 -&gt; 【输出长这样】</strong> 的结构来讲。</p>
<h3 id="第一切片动作选择-sampling">第一切片：动作选择 (Sampling)</h3>
<ul>
<li><strong>代码位置</strong>：<code>class PPO</code> 中的 <code>select_action</code> 函数。</li>
<li><strong>场景</strong>：游戏正在进行，每一个时间步调用一次。</li>
</ul>
<p><strong>1. 输入 (Input)</strong></p>
<ul>
<li>
<p>变量名：<code>state</code></p>
</li>
<li>
<p>长相：一个 Numpy 数组，代表当前游戏画面。</p>
<p>Python</p>
<pre><code># 假设 CartPole 的杆子稍微向右倾斜
state = np.array([0.01, 0.02, 0.05, 0.01]) 
# Shape: (4,)
</code></pre>
</li>
</ul>
<p><strong>2. 代码解析</strong></p>
<p>Python</p>
<pre><code>def select_action(self, state):
    with torch.no_grad(): # 停止梯度计算（省显存，只为了推理）
        
        # [步骤 A] 格式转换
        # 输入 shape: (4,) -&gt; 输出 shape: [1, 4]
        # 为什么要变成 [1, 4]? 因为神经网络习惯处理 Batch，哪怕只有一个数据也要伪装成 Batch。
        state = torch.FloatTensor(state).to(device) 

        # [步骤 B] 过网络 (Forward)
        # self.policy_old 是那个&quot;不带梯度&quot;的旧脑子
        # action_probs shape: [1, 2] -&gt; 例如 [[0.3, 0.7]] (30% 向左, 70% 向右)
        # _ 是 value，这里不需要，丢弃
        action_probs, _ = self.policy_old(state) 
        
        # [步骤 C] 创建分布
        # Categorical 会根据概率归一化。
        dist = Categorical(action_probs) 

        # [步骤 D] 采样 (Sampling)
        # 即使向右概率 0.7，sample() 也有可能抽到左。假设这次抽到了右 (1)。
        action = dist.sample() 
        # action 是一个 Tensor: tensor([1])

    # [步骤 E] 返回
    # action.item(): 把 tensor([1]) 变成 Python 整数 1
    # dist.log_prob(action): 算出 log(0.7) ≈ -0.356。这是为了后面算梯度用的。
    return action.item(), dist.log_prob(action)
</code></pre>
<p><strong>3. 输出 (Output)</strong></p>
<ul>
<li><strong>Action</strong> (给环境执行): <code>1</code></li>
<li><strong>Log_Prob</strong> (存入 Memory): <code>-0.356</code></li>
</ul>
<h3 id="第二切片优势计算-gae-calculation">第二切片：优势计算 (GAE Calculation)</h3>
<ul>
<li><strong>代码位置</strong>：<code>update</code> 函数的前半部分。</li>
<li><strong>场景</strong>：游戏玩了 2000 步，Memory 存满了，现在要把这堆原始数据加工成“优势值”。</li>
</ul>
<p><strong>1. 输入 (Input)</strong></p>
<p>Memory 里的一堆列表，已经通过 <code>torch.stack</code> 变成了 Tensor。</p>
<ul>
<li><code>rewards</code>: <code>[1, 1, ..., 1, 0]</code> (假设最后一步死了) -&gt; Shape: <code>[2000]</code></li>
<li><code>values</code>: <code>[0.1, 0.2, ..., 0.0]</code> (Critic 预测的分数) -&gt; Shape: <code>[2000]</code></li>
<li><code>is_terminals</code>: <code>[False, False, ..., True]</code></li>
</ul>
<p><strong>2. 代码解析</strong></p>
<p>Python</p>
<pre><code># 初始化容器
advantages = []
gae = 0 

# [关键循环] 倒着遍历！从第 2000 步往回走到第 1 步
# reversed(range(len(rewards))) -&gt; 1999, 1998, ..., 0
for i in reversed(range(len(rewards))):
    
    # [步骤 A] 判断是否结束
    if is_terminals[i]:
        gae = 0            # 如果这步死了，后续没有优势，归零
        next_value = 0     # 死了就没有未来的价值了
    else:
        # 如果没死，未来的价值就是 i+1 步原本预测的价值
        next_value = values[i + 1] if i + 1 &lt; len(values) else 0

    # [步骤 B] 计算单步惊喜 (Delta) - 论文公式 (12)
    # 现实 (reward + gamma * next) - 预期 (value)
    # 例子: 我拿了 1 分，下一状态值 10 分，但我原本以为只有 5 分。
    # delta = 1 + 0.99*10 - 5 = 5.9 (惊喜!)
    delta = rewards[i] + HYPERPARAMS['gamma'] * next_value - values[i]
    
    # [步骤 C] 计算累计优势 (GAE) - 论文公式 (11)
    # 今天的优势 = 今天的惊喜 + (衰减系数 * 明天的优势)
    # 这里的 gae 变量是一个累加器，把未来的优势传导回来
    gae = delta + HYPERPARAMS['gamma'] * HYPERPARAMS['lambda_gae'] * gae
    
    # [步骤 D] 插入头部 (因为是倒着算的，所以要插到列表最前面)
    advantages.insert(0, gae)
</code></pre>
<p><strong>3. 输出 (Output)</strong></p>
<ul>
<li><strong>advantages</strong>: 一个长度 2000 的 Tensor。</li>
<li>例如: <code>[1.5, 1.8, ..., -1.0]</code></li>
<li>含义: 正数代表该动作比平均好，负数代表该动作比平均差。</li>
</ul>
<h3 id="第三切片网络更新-optimization-loop">第三切片：网络更新 (Optimization Loop)</h3>
<ul>
<li><strong>代码位置</strong>：<code>update</code> 函数的 <code>for _ in range(epochs):</code> 循环内部。</li>
<li><strong>场景</strong>：有了数据和优势值，开始真正修改神经网络的参数（权重）。</li>
</ul>
<p><strong>1. 输入 (Input)</strong></p>
<ul>
<li><code>states</code>: 2000 张游戏截图 (<code>[2000, 4]</code>)</li>
<li><code>actions</code>: 当时做的 2000 个动作 (<code>[2000]</code>)</li>
<li><code>old_logprobs</code>: 当时的概率 (<code>[2000]</code>)</li>
<li><code>advantages</code>: 刚才算出来的优势 (<code>[2000]</code>)</li>
</ul>
<p><strong>2. 代码解析</strong></p>
<p>Python</p>
<pre><code># 每次 Epoch 都要重新跑一遍 Forward，因为网络参数 self.policy 在变
# evaluate 函数会返回三个东西：
# 1. logprobs: 新网络对这 2000 个动作现在的看法 (带有梯度!)
# 2. state_values: 新 Critic 对这 2000 个状态现在的打分
# 3. dist_entropy: 新网络的随机程度
logprobs, state_values, dist_entropy = self.policy.evaluate(states, actions)

# [步骤 A] 计算 Ratio (变化幅度)
# 公式: exp(new_log - old_log)
# 结果: 长度 2000 的 Tensor。如果是 1.0 代表没变，1.2 代表变了 20%
ratios = torch.exp(logprobs - old_logprobs)

# [步骤 B] 计算截断 (Clipping) - PPO 灵魂
# surr1: 激进派。如果 Ratio 很大，奖励直接起飞。
surr1 = ratios * advantages
# surr2: 保守派。把 Ratio 强行锁在 [0.8, 1.2] 之间。
surr2 = torch.clamp(ratios, 0.8, 1.2) * advantages

# 取两者的最小值 (min)。
# 为什么要负号? 因为 torch 是做梯度下降(minimize)，我们要最大化奖励。
loss_policy = -torch.min(surr1, surr2).mean()

# [步骤 C] Critic 的 Loss
# 希望 Critic 预测的分数 (state_values) 尽可能接近真实回报 (returns)
loss_value = self.MseLoss(state_values, returns)

# [步骤 D] 算总账
# 0.5 和 0.01 是权重系数。
# - 0.01 * entropy 是为了鼓励探索 (最大化熵 -&gt; 最小化负熵)
loss = loss_policy + 0.5 * loss_value - 0.01 * dist_entropy.mean()

# [步骤 E] 反向传播
self.optimizer.zero_grad() # 清空旧梯度
loss.backward()            # 计算新梯度 (这步最耗时)
self.optimizer.step()      # 修改 self.policy 的权重 w = w - lr * grad
</code></pre>
<p><strong>3. 输出 (Output)</strong></p>
<ul>
<li>没有直接的数据返回值。</li>
<li><strong>副作用 (Side Effect)</strong>：<code>self.policy</code> 神经网络里的 <code>weight</code> 和 <code>bias</code> 矩阵发生了微小的数值变化。</li>
<li><strong>结果</strong>：下一次你再把同样的 <code>state</code> 喂给网络，它输出的概率分布会稍微不同（更倾向于高分动作，更精准的价值预测）。</li>
</ul>
<hr>
<h2 id="总结全图">总结全图</h2>
<ol>
<li><strong>输入</strong>：<code>[0.1, -0.2...]</code> (State)</li>
<li><strong>Select Action</strong>：通过旧网络 -&gt; 算出概率 -&gt; 抽签 -&gt; <strong>输出动作 1</strong>。</li>
<li><strong>GAE Loop</strong>：把 2000 个动作结果连起来 -&gt; 倒推算出 -&gt; <strong>输出优势 [1.2, 0.5...]</strong>。</li>
<li><strong>Update Loop</strong>：拿 2000 个状态喂给新网络 -&gt; 算 Ratio -&gt; 算 Loss -&gt; 反向传播 -&gt; <strong>修改网络参数</strong>。</li>
</ol>
<hr>
<h2 id="完整代码-基于-gymnasium">完整代码 (基于 Gymnasium)</h2>
<p>Python</p>
<pre><code>import gymnasium as gym # Changed import statement to gymnasium
import torch
import torch.nn as nn
import torch.nn.functional as F
import torch.optim as optim
from torch.distributions import Categorical

# ==========================================
# 超参数设置 (参考论文 Appendix A)
# ==========================================
HYPERPARAMS ={
    'lr': 3e-4,                # 学习率
    'gamma': 0.99,             # 折扣因子 (Discount factor)
    'lambda_gae': 0.95,        # GAE 参数
    'clip_epsilon': 0.2,       # PPO 截断范围 (0.2 表示允许 20% 的变动)
    'epochs_per_iter': 10,     # 每次收集完数据后，训练网络的轮数
    'batch_size': 64,          # Mini-batch 大小
    'update_timestep': 2000,   # 每收集多少步数据进行一次更新 (Horizon T)
    'max_episodes': 2000,      # 总共跑多少个回合作为 Demo
}

device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)

# ==========================================
# 1. 定义网络架构 (Actor-Critic)
# ==========================================
class ActorCritic(nn.Module):
    def __init__(self, state_dim, action_dim):
        super(ActorCritic, self).__init__()

        # 共享特征提取层 (Backbone)
        self.feature_layer = nn.Sequential(
            nn.Linear(state_dim, 64),
            nn.Tanh(), # 论文中使用了 tanh 激活函数
            nn.Linear(64, 64),
            nn.Tanh()
        )

        # Actor 头: 输出动作概率 (Policy)
        self.actor = nn.Linear(64, action_dim)

        # Critic 头: 输出状态价值 (Value)
        self.critic = nn.Linear(64, 1)

    def forward(self, state):
        features = self.feature_layer(state)

        # Actor 逻辑
        action_probs = F.softmax(self.actor(features), dim=-1)

        # Critic 逻辑
        state_value = self.critic(features)

        return action_probs, state_value

    def evaluate(self, state, action):
        &quot;&quot;&quot;
        在更新参数时使用。计算当前状态下的 log_prob, entropy 和 value
        &quot;&quot;&quot;
        action_probs, state_value = self.forward(state)
        dist = Categorical(action_probs)

        action_logprobs = dist.log_prob(action)
        dist_entropy = dist.entropy()

        return action_logprobs, state_value, dist_entropy

# ==========================================
# 2. PPO 算法核心类
# ==========================================
class PPO:
    def __init__(self, env):
        self.env = env
        self.state_dim = env.observation_space.shape[0]
        self.action_dim = env.action_space.n

        self.policy = ActorCritic(self.state_dim, self.action_dim).to(device)
        self.optimizer = optim.Adam(self.policy.parameters(), lr=HYPERPARAMS['lr'])
        self.policy_old = ActorCritic(self.state_dim, self.action_dim).to(device)
        self.policy_old.load_state_dict(self.policy.state_dict()) # 初始化旧策略

        self.MseLoss = nn.MSELoss()

    def select_action(self, state):
        &quot;&quot;&quot;
        在收集数据阶段使用 (Sampling)
        &quot;&quot;&quot;
        with torch.no_grad():
            state = torch.FloatTensor(state).to(device)
            action_probs, _ = self.policy_old(state) # 用旧策略采样
            dist = Categorical(action_probs)
            action = dist.sample()

        return action.item(), dist.log_prob(action)

    def update(self, memory):
        # 转换数据为 Tensor
        states = torch.stack(memory.states).to(device).detach()
        actions = torch.stack(memory.actions).to(device).detach()
        old_logprobs = torch.stack(memory.logprobs).to(device).detach()
        rewards = memory.rewards
        is_terminals = memory.is_terminals

        # ------------------------------------------
        # 核心公式 (11) &amp; (12): 计算 GAE (优势函数)
        # ------------------------------------------
        # GAE 需要倒着算，所以先把 value 算出来
        # 这里的 values 是用旧网络预测的，不参与梯度反向传播
        with torch.no_grad():
             _, values = self.policy(states)
             values = values.squeeze()

        advantages = []
        gae = 0

        # 倒序遍历每一步
        for i in reversed(range(len(rewards))):
            if is_terminals[i]:
                gae = 0
                next_value = 0
            else:
                # 如果不是最后一步，next_value 就是下一步的 value
                # 注意：这里简化处理，假设 memory 存的是连续的一段
                next_value = values[i + 1] if i + 1 &lt; len(values) else 0

            # delta_t = r_t + gamma * V(s_{t+1}) - V(s_t)  [论文公式 12]
            delta = rewards[i] + HYPERPARAMS['gamma'] * next_value - values[i]

            # A_t = delta_t + (gamma * lambda) * A_{t+1}   [论文公式 11]
            gae = delta + HYPERPARAMS['gamma'] * HYPERPARAMS['lambda_gae'] * gae
            advantages.insert(0, gae) # 插入到最前面

        # 转换为 Tensor 并进行归一化 (Normalization) - 这是一个训练稳定的重要技巧
        advantages = torch.tensor(advantages, dtype=torch.float32).to(device)
        advantages = (advantages - advantages.mean()) / (advantages.std() + 1e-5)

        # 计算 Returns (用于训练 Critic 的目标值): Return = Advantage + Value
        returns = advantages + values

        # ------------------------------------------
        # 核心循环: K Epochs 优化
        # ------------------------------------------
        for _ in range(HYPERPARAMS['epochs_per_iter']):

            # 重新评估当前状态 (获取新的 log_prob 和 value)
            logprobs, state_values, dist_entropy = self.policy.evaluate(states, actions)

            state_values = state_values.squeeze()

            # 1. 计算 Ratio r_t(theta) [论文公式 6]
            # ratio = exp(new_log - old_log)
            ratios = torch.exp(logprobs - old_logprobs)

            # 2. 计算 Surrogate Loss (Clipped) [论文公式 7]
            surr1 = ratios * advantages
            surr2 = torch.clamp(ratios,
                                1 - HYPERPARAMS['clip_epsilon'],
                                1 + HYPERPARAMS['clip_epsilon']) * advantages

            # PPO 的策略 Loss 是取 min 后取负 (因为我们要最大化目标，PyTorch 是最小化 Loss)
            loss_policy = -torch.min(surr1, surr2).mean()

            # 3. 计算 Value Loss (MSE)
            loss_value = self.MseLoss(state_values, returns)

            # 4. 计算 Total Loss [论文公式 9]
            # loss = Policy Loss + 0.5 * Value Loss - 0.01 * Entropy
            loss = loss_policy + 0.5 * loss_value - 0.01 * dist_entropy.mean()

            # 梯度下降
            self.optimizer.zero_grad()
            loss.backward()
            self.optimizer.step()

        # 训练结束后，更新旧策略参数
        self.policy_old.load_state_dict(self.policy.state_dict())

# ==========================================
# 辅助类: 简单的经验回放池
# ==========================================
class Memory:
    def __init__(self):
        self.actions = []
        self.states = []
        self.logprobs = []
        self.rewards = []
        self.is_terminals = []

    def clear(self):
        del self.actions[:]
        del self.states[:]
        del self.logprobs[:]
        del self.rewards[:]
        del self.is_terminals[:]

# ==========================================
# 主程序
# ==========================================
def main():
    # 创建环境
    env = gym.make('CartPole-v1') # CartPole-v1 最高分 500

    ppo_agent = PPO(env)
    memory = Memory()

    time_step = 0
    running_reward = 0

    # 训练循环
    for i_episode in range(1, HYPERPARAMS['max_episodes'] + 1):
        state, _ = env.reset() # Modified for gymnasium API, returns observation and info
        current_ep_reward = 0

        for t in range(1, 10000): # 单个回合最大步数
            time_step += 1

            # 1. 运行旧策略收集数据
            action, log_prob = ppo_agent.select_action(state)
            next_state, reward, done, truncated, _ = env.step(action)
            done = done or truncated

            # 存储数据
            memory.states.append(torch.FloatTensor(state))
            memory.actions.append(torch.tensor(action))
            memory.logprobs.append(log_prob)
            memory.rewards.append(reward)
            memory.is_terminals.append(done)

            state = next_state
            current_ep_reward += reward

            # 2. 如果收集了足够长的数据 (Timesteps)，就进行更新
            if time_step % HYPERPARAMS['update_timestep'] == 0:
                print(f&quot;Update: System Learning... (Timestep: {time_step})&quot;)
                ppo_agent.update(memory)
                memory.clear()
                time_step = 0

            if done:
                break

        running_reward += current_ep_reward

        # 打印日志
        if i_episode % 20 == 0:
            avg_reward = running_reward / 20
            print(f&quot;Episode {i_episode} \t Average Reward: {avg_reward}&quot;)
            running_reward = 0

            if avg_reward &gt; 475: # CartPole-v1 满分 500，达到 475 就算解决
                print(&quot;########## Solved! ##########&quot;)
                break

if __name__ == '__main__':
    main()
</code></pre>
<h3 id="运行结果日志">运行结果日志</h3>
<p>Plaintext</p>
<pre><code>Episode 1760     Average Reward: 469.95
Update: System Learning... (Timestep: 2000)
Update: System Learning... (Timestep: 2000)
Update: System Learning... (Timestep: 2000)
Update: System Learning... (Timestep: 2000)
Update: System Learning... (Timestep: 2000)
Episode 1780     Average Reward: 453.4
Update: System Learning... (Timestep: 2000)
Update: System Learning... (Timestep: 2000)
Update: System Learning... (Timestep: 2000)
Update: System Learning... (Timestep: 2000)
Update: System Learning... (Timestep: 2000)
Episode 1800     Average Reward: 461.45
Update: System Learning... (Timestep: 2000)
Update: System Learning... (Timestep: 2000)
Update: System Learning... (Timestep: 2000)
Update: System Learning... (Timestep: 2000)
Episode 1820     Average Reward: 470.0
Update: System Learning... (Timestep: 2000)
Update: System Learning... (Timestep: 2000)
Update: System Learning... (Timestep: 2000)
Update: System Learning... (Timestep: 2000)
Update: System Learning... (Timestep: 2000)
Episode 1840     Average Reward: 499.65
########## Solved! ##########
</code></pre>
<pre><code>A. PPO Clip Loss (重中之重)
这是考察概率最高的代码段。你不需要写整个网络，但这 5-6 行核心逻辑必须会写：

Python

# 必须能手写出来的片段
def ppo_loss(old_log_probs, log_probs, advantages, epsilon=0.2):
    ratio = torch.exp(log_probs - old_log_probs)
    surr1 = ratio * advantages
    surr2 = torch.clamp(ratio, 1.0 - epsilon, 1.0 + epsilon) * advantages
    # 注意是取 min，然后因为是梯度下降求最小，所以加负号
    loss = -torch.min(surr1, surr2).mean()
    return loss
</code></pre>
<p>这个问题问得非常敏锐！这说明你对 PPO 的数学定义非常清楚。</p>
<p>你的直觉是对的：<strong>数学定义里确实是除法</strong>。</p>
<p>但在<strong>写代码（工程实现）时</strong>，我们通常将其转换为 <strong>“先减后指数”</strong> 的形式。</p>
<p>这主要有两个原因：<strong>1. 数学等价性</strong>，<strong>2. 数值稳定性（计算机的精度问题）</strong>。</p>
<h3 id="1-数学原理对数性质">1. 数学原理：对数性质</h3>
<p>回顾一下初中/高中的对数公式：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>log</mi><mo>⁡</mo><mo>(</mo><mfrac><mi>a</mi><mi>b</mi></mfrac><mo>)</mo><mo>=</mo><mi>log</mi><mo>⁡</mo><mo>(</mo><mi>a</mi><mo>)</mo><mo>−</mo><mi>log</mi><mo>⁡</mo><mo>(</mo><mi>b</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">\log(\frac{a}{b}) = \log(a) - \log(b)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.7935600000000003em;vertical-align:-0.686em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.10756em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">b</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord mathdefault">b</span><span class="mclose">)</span></span></span></span></span></p>
<p>在 PPO 中，我们想求的比率（Ratio）是：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>r</mi><mi>t</mi></msub><mo>(</mo><mi>θ</mi><mo>)</mo><mo>=</mo><mfrac><msub><mi>π</mi><mrow><mi>n</mi><mi>e</mi><mi>w</mi></mrow></msub><msub><mi>π</mi><mrow><mi>o</mi><mi>l</mi><mi>d</mi></mrow></msub></mfrac></mrow><annotation encoding="application/x-tex">r_t(\theta) = \frac{\pi_{new}}{\pi_{old}}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.94356em;vertical-align:-0.8360000000000001em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1075599999999999em;"><span style="top:-2.3139999999999996em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8360000000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>如果我们两边同时取对数（ln）：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>log</mi><mo>⁡</mo><mo>(</mo><msub><mi>r</mi><mi>t</mi></msub><mo>)</mo><mo>=</mo><mi>log</mi><mo>⁡</mo><mo>(</mo><mfrac><msub><mi>π</mi><mrow><mi>n</mi><mi>e</mi><mi>w</mi></mrow></msub><msub><mi>π</mi><mrow><mi>o</mi><mi>l</mi><mi>d</mi></mrow></msub></mfrac><mo>)</mo><mo>=</mo><mi>log</mi><mo>⁡</mo><mo>(</mo><msub><mi>π</mi><mrow><mi>n</mi><mi>e</mi><mi>w</mi></mrow></msub><mo>)</mo><mo>−</mo><mi>log</mi><mo>⁡</mo><mo>(</mo><msub><mi>π</mi><mrow><mi>o</mi><mi>l</mi><mi>d</mi></mrow></msub><mo>)</mo></mrow><annotation encoding="application/x-tex">\log(r_t) = \log(\frac{\pi_{new}}{\pi_{old}}) = \log(\pi_{new}) - \log(\pi_{old})
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.94356em;vertical-align:-0.8360000000000001em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1075599999999999em;"><span style="top:-2.3139999999999996em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8360000000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p>那么，要把 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>log</mi><mo>⁡</mo><mo>(</mo><msub><mi>r</mi><mi>t</mi></msub><mo>)</mo></mrow><annotation encoding="application/x-tex">\log(r_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 变回 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>r</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">r_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，我们需要做对数的逆运算，也就是指数运算 (<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>e</mi><mi>x</mi></msup></mrow><annotation encoding="application/x-tex">e^x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.664392em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span></span></span></span></span></span></span></span>)：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>r</mi><mi>t</mi></msub><mo>=</mo><msup><mi>e</mi><mrow><mi>log</mi><mo>⁡</mo><mo>(</mo><msub><mi>π</mi><mrow><mi>n</mi><mi>e</mi><mi>w</mi></mrow></msub><mo>)</mo><mo>−</mo><mi>log</mi><mo>⁡</mo><mo>(</mo><msub><mi>π</mi><mrow><mi>o</mi><mi>l</mi><mi>d</mi></mrow></msub><mo>)</mo></mrow></msup></mrow><annotation encoding="application/x-tex">r_t = e^{\log(\pi_{new}) - \log(\pi_{old})}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.938em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285719em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span><span class="mbin mtight">−</span><span class="mop mtight">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>对应到代码里就是：</strong></p>
<p>Python</p>
<pre><code># ratio = exp(new_log - old_log)
ratio = torch.exp(log_probs - old_log_probs)
</code></pre>
<hr>
<h3 id="2-工程原因数值稳定性-numerical-stability">2. 工程原因：数值稳定性 (Numerical Stability)</h3>
<p>这是更重要的原因。在深度学习中，<strong>直接处理概率值（Probability）是非常危险的</strong>，而处理<strong>对数概率（Log Probability）</strong> 却非常安全。</p>
<h4 id="为什么概率很危险">为什么概率很危险？</h4>
<p>神经网络输出的概率值往往非常小。</p>
<p>比如在一个复杂的动作空间里，某个动作的概率可能是 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>0.0000001</mn></mrow><annotation encoding="application/x-tex">0.0000001</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">1</span></span></span></span> (<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>7</mn></mrow></msup></mrow><annotation encoding="application/x-tex">10^{-7}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">7</span></span></span></span></span></span></span></span></span></span></span></span>)。</p>
<ul>
<li>如果你让计算机直接做乘除法：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>0.0000001</mn><mo>×</mo><mn>0.0000001</mn></mrow><annotation encoding="application/x-tex">0.0000001 \times 0.0000001</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">1</span></span></span></span>，结果会变成 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>14</mn></mrow></msup></mrow><annotation encoding="application/x-tex">10^{-14}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span><span class="mord mtight">4</span></span></span></span></span></span></span></span></span></span></span></span>。</li>
<li>在浮点数精度有限的情况下，极小的数字会被计算机直接<strong>当作 0 处理（Underflow，下溢出）</strong>。一旦分母变成 0，程序就崩了（NaN）。</li>
</ul>
<h4 id="为什么对数很安全">为什么对数很安全？</h4>
<p>取了对数之后，极小的数字这就变成了“普通大小”的负数：</p>
<ul>
<li>
<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>log</mi><mo>⁡</mo><mo>(</mo><mn>1</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>7</mn></mrow></msup><mo>)</mo><mo>≈</mo><mo>−</mo><mn>16.1</mn></mrow><annotation encoding="application/x-tex">\log(10^{-7}) \approx -16.1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">7</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord">1</span><span class="mord">6</span><span class="mord">.</span><span class="mord">1</span></span></span></span></p>
</li>
<li>
<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>log</mi><mo>⁡</mo><mo>(</mo><mn>1</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>14</mn></mrow></msup><mo>)</mo><mo>≈</mo><mo>−</mo><mn>32.2</mn></mrow><annotation encoding="application/x-tex">\log(10^{-14}) \approx -32.2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span><span class="mord mtight">4</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord">3</span><span class="mord">2</span><span class="mord">.</span><span class="mord">2</span></span></span></span></p>
<p>计算机处理 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>−</mo><mn>16.1</mn><mo>−</mo><mo>(</mo><mo>−</mo><mn>16.1</mn><mo>)</mo></mrow><annotation encoding="application/x-tex">-16.1 - (-16.1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord">1</span><span class="mord">6</span><span class="mord">.</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">−</span><span class="mord">1</span><span class="mord">6</span><span class="mord">.</span><span class="mord">1</span><span class="mclose">)</span></span></span></span> 这种加减法，比处理 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>7</mn></mrow></msup><mi mathvariant="normal">/</mi><mn>1</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>7</mn></mrow></msup></mrow><annotation encoding="application/x-tex">10^{-7} / 10^{-7}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">7</span></span></span></span></span></span></span></span></span><span class="mord">/</span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">7</span></span></span></span></span></span></span></span></span></span></span></span> 这种除法要精准得多，也稳定得多。</p>
</li>
</ul>
<ol>
<li><strong>PyTorch 的习惯</strong>：我们在神经网络输出层通常直接使用 <code>log_softmax</code> 或者 <code>dist.log_prob()</code>，拿到的直接就是 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>log</mi><mo>⁡</mo><mo>(</mo><mi>p</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">\log(p)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord mathdefault">p</span><span class="mclose">)</span></span></span></span>，而不是 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span></span></span></span>。</li>
<li><strong>避免除法</strong>：既然手里拿的已经是 Log 值了，利用 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mfrac><mi>a</mi><mi>b</mi></mfrac><mo>⇔</mo><mi>exp</mi><mo>⁡</mo><mo>(</mo><mi>log</mi><mo>⁡</mo><mi>a</mi><mo>−</mo><mi>log</mi><mo>⁡</mo><mi>b</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">\frac{a}{b} \Leftrightarrow \exp(\log a - \log b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.040392em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.695392em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">b</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">a</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⇔</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">exp</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">a</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">b</span><span class="mclose">)</span></span></span></span> 这个性质计算比率，既省事又不会因为精度丢失而报错。</li>
</ol>
<p>所以，这行代码本质上<strong>就是在做除法</strong>，只是换了一件更符合计算机口味的“马甲”。</p>
<p>这触及到了深度学习训练中最基础的一个概念：<strong>Batch（批量）处理</strong>。</p>
<p>简单来说，加 <code>.mean()</code> 是为了把**“一堆数据的损失”<strong>变成</strong>“一个代表性的数字”**，这样计算机才能进行优化。</p>
<p>以下是详细的三个原因：</p>
<h3 id="1-形状的变化从一列数变成一个数">1. 形状的变化：从“一列数”变成“一个数”</h3>
<p>在你的代码中，<code>batch_size</code> 设为了 64（或者 2000）。这意味着每次计算时，<code>surr1</code> 和 <code>surr2</code> 不是一个数字，而是一个<strong>长长的向量（Vector）</strong>。</p>
<ul>
<li><code>surr1</code> 的形状是：<code>[64]</code> （代表这 64 个动作每一个的潜力）</li>
<li><code>torch.min(surr1, surr2)</code> 的形状也是：<code>[64]</code> （算出了这 64 个动作每一个的最终修正奖励）</li>
</ul>
<p><strong>但是</strong>，PyTorch 的 <code>loss.backward()</code> 函数通常需要一个<strong>标量（Scalar，即单独一个数字）**来作为起点计算梯度。它不知道怎么对“一列数”同时做反向传播，它需要你告诉它：“这一批数据的**总体表现</strong>怎么样？”</p>
<p>所以，<code>.mean()</code> 做的就是：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mtext>Loss</mtext><mo>=</mo><mfrac><mn>1</mn><mi>N</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><msub><mtext>loss</mtext><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\text{Loss} = \frac{1}{N} \sum_{i=1}^{N} \text{loss}_i
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord text"><span class="mord">Loss</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.106005em;vertical-align:-1.277669em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">N</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283360000000002em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">N</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.277669em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord text"><span class="mord">loss</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p>它把这 64 个样本的损失加起来除以 64，得到一个平均值。</p>
<h3 id="2-梯度的稳定性为什么要-mean-不要-sum">2. 梯度的稳定性（为什么要 Mean 不要 Sum？）</h3>
<p>你可能会问：<em>“那我用求和 <code>.sum()</code> 变成一个数字行不行？”</em></p>
<p>答案是：<strong>代码能跑，但效果不好。</strong></p>
<ul>
<li><strong>如果用 <code>.sum()</code></strong>：
<ul>
<li>当你用 batch_size = 32 时，总 Loss 可能是 320。</li>
<li>当你换成 batch_size = 64 时，总 Loss 可能变成 640。</li>
<li><strong>后果</strong>：你的梯度（Gradient）会随着 Batch Size 变大而变大。这意味着你每改一次 Batch Size，就得重新费劲去调学习率（Learning Rate），否则模型容易“步子太大”扯着蛋。</li>
</ul>
</li>
<li><strong>如果用 <code>.mean()</code></strong>：
<ul>
<li>无论 batch_size 是 32 还是 64，平均下来的 Loss 都在 10 左右。</li>
<li><strong>好处</strong>：梯度的幅度是稳定的。你的学习率（<code>3e-4</code>）可以通用，不需要随着 Batch Size 的变化而频繁调整。</li>
</ul>
</li>
</ul>
<h3 id="3-数学含义期望expectation">3. 数学含义：期望（Expectation）</h3>
<p>回顾一下 PPO 的公式：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>L</mi><mo>(</mo><mi>θ</mi><mo>)</mo><mo>=</mo><msub><mover accent="true"><mi mathvariant="double-struck">E</mi><mo>^</mo></mover><mi>t</mi></msub><mo>[</mo><mo>…</mo><mtext> </mtext><mo>]</mo></mrow><annotation encoding="application/x-tex">L(\theta) = \hat{\mathbb{E}}_t [\dots]
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">L</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.20233em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9523299999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span></span></span><span style="top:-3.25789em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.16666em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">[</span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mclose">]</span></span></span></span></span></p>
<p>符号 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mover accent="true"><mi mathvariant="double-struck">E</mi><mo>^</mo></mover><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">\hat{\mathbb{E}}_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1023299999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9523299999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span></span></span><span style="top:-3.25789em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.16666em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 代表 <strong>“期望” (Expectation)</strong>。</p>
<p>在统计学里，当我们有一堆样本数据时，“计算期望”最直接的方法就是<strong>求平均值</strong>。</p>
<p><strong>总结：</strong></p>
<p>加 <code>.mean()</code> 是为了：</p>
<ol>
<li><strong>工程上</strong>：把 <code>[Batch]</code> 维度的向量压缩成一个标量，喂给 <code>backward()</code>。</li>
<li><strong>训练上</strong>：让梯度大小标准化，不受 Batch Size 影响，让训练更稳定。</li>
</ol>
<pre><code>B. GAE 计算逻辑 (逻辑考察)
面试官可能不要求语法完全正确，但会看你是不是知道要倒着算。

Python

# 伪代码或关键逻辑
gae = 0
returns = []
for step in reversed(range(len(rewards))):
    delta = rewards[step] + gamma * values[step+1] - values[step]
    gae = delta + gamma * lambda * gae
    returns.insert(0, gae + values[step])
</code></pre>
<p>这是一个非常敏锐的问题！这触及到了 Actor-Critic 架构中 <strong>Actor</strong> 和 <strong>Critic</strong> 两个网络训练目标的本质区别。</p>
<p>简单来说：<strong><code>gae</code> 是给 Actor 用的，而 <code>returns</code> 是给 Critic 用的。</strong></p>
<p>我们来详细拆解一下原因：</p>
<h3 id="1-数学公式还原真相">1. 数学公式：还原真相</h3>
<p>回顾一下我们之前定义的公式：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mtext>优势 (Advantage/GAE)</mtext><mo>=</mo><mtext>真实回报 (Return)</mtext><mo>−</mo><mtext>预期价值 (Value)</mtext></mrow><annotation encoding="application/x-tex">\text{优势 (Advantage/GAE)} = \text{真实回报 (Return)} - \text{预期价值 (Value)}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord cjk_fallback">优势</span><span class="mord"> (Advantage/GAE)</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord cjk_fallback">真实回报</span><span class="mord"> (Return)</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord cjk_fallback">预期价值</span><span class="mord"> (Value)</span></span></span></span></span></span></p>
<p>把这个公式做一个简单的移项变换，求“真实回报”：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mtext>真实回报 (Return)</mtext><mo>=</mo><mtext>预期价值 (Value)</mtext><mo>+</mo><mtext>优势 (Advantage/GAE)</mtext></mrow><annotation encoding="application/x-tex">\text{真实回报 (Return)} = \text{预期价值 (Value)} + \text{优势 (Advantage/GAE)}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord cjk_fallback">真实回报</span><span class="mord"> (Return)</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord cjk_fallback">预期价值</span><span class="mord"> (Value)</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord cjk_fallback">优势</span><span class="mord"> (Advantage/GAE)</span></span></span></span></span></span></p>
<p>对应到你的代码里就是：</p>
<pre><code>returns = values[step] + gae
</code></pre>
<h3 id="2-为什么要还原给-critic-看">2. 为什么要还原？（给 Critic 看）</h3>
<p>这一步是为了计算 <strong>Critic 的 Loss</strong>。</p>
<ul>
<li>
<p><strong>Critic 的任务是什么？</strong></p>
<p>Critic 是个预言家，它的工作是预测“这个状态到底值多少分（绝对值）”。</p>
<p>比如：它预测在这个位置能拿 <strong>80分</strong>。</p>
</li>
<li>
<p><strong>Critic 怎么训练？</strong></p>
<p>我们需要告诉 Critic：“你预测了 80 分，但实际上如果你从这里开始玩，最后算下来的真实得分是 <strong>90分</strong>。所以你有 10 分的误差（Loss），你要根据这个误差去修改参数，下次预测准点。”</p>
</li>
<li>
<p><strong>这里的 90 分是怎么来的？</strong></p>
<ul>
<li><strong>预期 (Value)</strong>：Critic 自己预测的 80 分。</li>
<li><strong>惊喜 (GAE)</strong>：算出这把玩得比预期好了 10 分。</li>
<li><strong>真相 (Return)</strong>：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>80</mn><mo>+</mo><mn>10</mn><mo>=</mo><mn>90</mn></mrow><annotation encoding="application/x-tex">80 + 10 = 90</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">8</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">9</span><span class="mord">0</span></span></span></span>。</li>
</ul>
</li>
</ul>
<p><strong>如果没有加上 <code>values[step]</code>：</strong></p>
<p>你传给 Critic 的目标就只剩下 <code>gae</code>（10分）。</p>
<p>Critic 会困惑：“啊？我预测 80 分，你告诉我目标是 10 分？那我下次预测 10 分？”</p>
<p><strong>这就不对了！</strong> Critic 预测的是<strong>总分</strong>，而不是<strong>偏差</strong>。</p>
<h3 id="3-代码中的去向">3. 代码中的去向</h3>
<p>请看代码后面计算 Loss 的部分：</p>
<p>Python</p>
<pre><code># 1. 训练 Actor（策略）用的是 gae (即 advantages)
# Actor 只需要知道“比平时好”还是“比平时差”，所以用相对值
surr1 = ratios * advantages 

# ... (中间省略)

# 2. 训练 Critic（价值）用的是 returns
# Critic 需要预测准确的总分，所以要用 (预期 + 优势) 还原出来的绝对值
loss_value = self.MseLoss(state_values, returns) 
</code></pre>
<h3 id="总结">总结</h3>
<ul>
<li><strong>GAE (<code>gae</code>)</strong>：是<strong>相对值</strong>（差值）。告诉 Actor：“这波操作比平时秀了多少”，用来调整动作概率。</li>
<li><strong>Returns (<code>gae + values</code>)</strong>：是<strong>绝对值</strong>（总分）。告诉 Critic：“这波操作实际到底拿了多少分”，用来校准 Critic 的预测能力。</li>
</ul>
<p>就像考试：</p>
<ul>
<li><strong>GAE</strong> 是：“我比平均分高了 5 分”。（用来表扬自己）</li>
<li><strong>Returns</strong> 是：“我实际考了 85 分”。（用来记录成绩）</li>
</ul>
<p>好的，这是面试中非常核心的部分。这些问题不仅仅是考察你“会不会写代码”，而是考察你**“懂不懂为什么这么写”<strong>以及</strong>“在工程实践中遇到坑怎么填”**。</p>
<p>我把这些问题拆解开，一个个给你详细解答，你可以直接把这些作为你的“面试标准答案库”。</p>
<hr>
<h3 id="第一板块常见-trick-考察-why-how">第一板块：常见 Trick 考察 (Why &amp; How)</h3>
<p>面试官问这些 Trick，是想确认你是不是真的训练过 PPO，因为原版论文的朴素实现往往很难收敛，必须加上这些技巧。</p>
<h4 id="1-advantage-normalization-优势归一化">1. Advantage Normalization (优势归一化)</h4>
<ul>
<li><strong>问题</strong>：“为什么要对 Advantage 做归一化？”</li>
<li><strong>代码对应</strong>：在你之前的代码里有一行 <code>advantages = (advantages - advantages.mean()) / (advantages.std() + 1e-5)</code>。</li>
<li><strong>答案解析</strong>：
<ul>
<li><strong>原因</strong>：原始的 Advantage 值波动可能很大。有的 Batch 可能是 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>[</mo><mn>100</mn><mo separator="true">,</mo><mn>110</mn><mo>]</mo></mrow><annotation encoding="application/x-tex">[100, 110]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">1</span><span class="mord">0</span><span class="mclose">]</span></span></span></span>，有的可能是 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>[</mo><mo>−</mo><mn>5</mn><mo separator="true">,</mo><mn>5</mn><mo>]</mo></mrow><annotation encoding="application/x-tex">[-5, 5]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">−</span><span class="mord">5</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">5</span><span class="mclose">]</span></span></span></span>。如果不归一化，梯度更新的幅度会忽大忽小，导致训练不稳定。</li>
<li><strong>作用</strong>：强制把优势值拉回到均值为 0、方差为 1 的正态分布。这样 Critic 只需要判断“相对好坏”，而不是“绝对数值大小”，能显著加速收敛。</li>
<li><strong>一句话回答</strong>：“为了让梯度更新的尺度统一，像老师改卷子一样，不看绝对分，看排名（标准分），让训练更稳定。”</li>
</ul>
</li>
</ul>
<h4 id="2-orthogonal-initialization-正交初始化">2. Orthogonal Initialization (正交初始化)</h4>
<ul>
<li><strong>问题</strong>：“你的网络权重是怎么初始化的？”</li>
<li><strong>答案解析</strong>：
<ul>
<li><strong>普通初始化</strong>：通常用高斯分布（随机数）。但在深层网络中，这容易导致梯度消失或爆炸。</li>
<li><strong>正交初始化</strong>：让权重矩阵的列向量相互正交（垂直）。</li>
<li><strong>作用</strong>：它能保持输入信号的“模长”在经过每一层时不变。这对于 RL 这种长序列任务特别重要，能让信号传得更远，不至于一开始就死掉。</li>
<li><strong>一句话回答</strong>：“为了防止梯度消失或爆炸，特别是在 RL 这种长序列决策中，正交初始化能保证信号在网络深层传递时保持稳定。”</li>
</ul>
</li>
</ul>
<h4 id="3-gradient-clipping-梯度裁剪">3. Gradient Clipping (梯度裁剪)</h4>
<ul>
<li><strong>问题</strong>：“除了 PPO 的 Ratio Clip，你还用了什么 Clip？”</li>
<li><strong>注意</strong>：别搞混了！PPO 的 Clip 是截断目标函数（Ratio），这里问的是截断<strong>梯度</strong>。</li>
<li><strong>代码对应</strong>：<code>torch.nn.utils.clip_grad_norm_(model.parameters(), 0.5)</code></li>
<li><strong>答案解析</strong>：
<ul>
<li><strong>原因</strong>：有时候遇到极端数据，算出来的梯度会特别大（Exploding Gradient）。这一下更新下去，好不容易训练好的模型参数可能直接飞出银河系（数值溢出或崩塌）。</li>
<li><strong>作用</strong>：设置一个阈值（比如 0.5）。如果梯度向量的长度超过 0.5，就按比例缩小它，保证方向不变，但步子别迈太大。</li>
<li><strong>一句话回答</strong>：“为了防止梯度爆炸。给参数更新加一个‘限速器’，保证模型不会因为一次坏数据就彻底崩坏。”</li>
</ul>
</li>
</ul>
<h4 id="4-learning-rate-decay-学习率衰减">4. Learning Rate Decay (学习率衰减)</h4>
<ul>
<li><strong>问题</strong>：“你的学习率是固定的吗？”</li>
<li><strong>答案解析</strong>：
<ul>
<li><strong>做法</strong>：刚开始训练时 LR 大一点（如 3e-4），为了快速学到东西；训练后期 LR 变小（线性衰减到 0），为了精细微调。</li>
<li><strong>作用</strong>：如果一直用大 LR，模型最后会在最优解附近震荡，进不去；用了衰减能让模型收敛得更准。</li>
</ul>
</li>
</ul>
<h4 id="5-log_prob-的数值稳定性">5. Log_prob 的数值稳定性</h4>
<ul>
<li><strong>问题</strong>：“为什么用 log_prob？”</li>
<li><strong>答案解析</strong>：见上一轮对话。
<ul>
<li><strong>关键词</strong>：<strong>下溢出 (Underflow)</strong>。概率连乘 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>0.</mn><msup><mn>1</mn><mn>100</mn></msup></mrow><annotation encoding="application/x-tex">0.1^{100}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mord mtight">0</span></span></span></span></span></span></span></span></span></span></span></span> 会变成 0，取 Log 变成加法就不会。</li>
</ul>
</li>
</ul>
<hr>
<h3 id="第二板块on-policy-vs-off-policy-概念深挖">第二板块：On-policy vs Off-policy (概念深挖)</h3>
<h4 id="1-ppo-为什么是-on-policy-的">1. PPO 为什么是 On-policy 的？</h4>
<ul>
<li><strong>面试官的陷阱</strong>：PPO 不是复用了数据训练了 10 个 Epoch 吗？复用数据不是 Off-policy 吗？</li>
<li><strong>标准答案</strong>：
<ul>
<li><strong>定义</strong>：On-policy 要求产生数据的策略 (<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>π</mi><mrow><mi>b</mi><mi>e</mi><mi>h</mi><mi>a</mi><mi>v</mi><mi>i</mi><mi>o</mi><mi>r</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\pi_{behavior}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">b</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight">h</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>) 和正在优化的策略 (<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>π</mi><mrow><mi>t</mi><mi>a</mi><mi>r</mi><mi>g</mi><mi>e</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\pi_{target}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.28055599999999997em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">g</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>) 必须是<strong>同一个</strong>。</li>
<li><strong>PPO 的情况</strong>：
<ul>
<li>我们用 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>π</mi><mrow><mi>o</mi><mi>l</mi><mi>d</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\pi_{old}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 收集数据。</li>
<li>在 <code>update</code> 的循环里，我们的网络变成了 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>π</mi><mrow><mi>n</mi><mi>e</mi><mi>w</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\pi_{new}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>。</li>
<li>虽然 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>π</mi><mrow><mi>o</mi><mi>l</mi><mi>d</mi></mrow></msub><mi mathvariant="normal">≠</mi><msub><mi>π</mi><mrow><mi>n</mi><mi>e</mi><mi>w</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\pi_{old} \neq \pi_{new}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mrel"><span class="mord"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.69444em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="rlap"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="inner"><span class="mrel"></span></span><span class="fix"></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span></span><span class="mrel">=</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，但 PPO 强制限制了它们之间的差异（通过 Clip）。</li>
<li><strong>关键点</strong>：这批数据一旦训练完这 10 个 Epoch，就<strong>扔掉了</strong>！我们绝不会像 DQN 那样把数据存进硬盘，明天拿出来再训练。</li>
<li>因为数据“即用即扔”，且 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>π</mi><mrow><mi>o</mi><mi>l</mi><mi>d</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\pi_{old}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>π</mi><mrow><mi>n</mi><mi>e</mi><mi>w</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\pi_{new}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 极度相似，所以它在宏观上依然被归类为 <strong>On-policy</strong>。</li>
</ul>
</li>
</ul>
</li>
<li><strong>Replay Buffer 里的秘密</strong>：
<ul>
<li>Off-policy (如 DQN/SAC) 的 Buffer 很大（存 100万条），为了打破相关性。</li>
<li>On-policy (PPO) 的 Buffer 很小（只存 2000条），只是为了算 GAE 和 Batch 训练。</li>
</ul>
</li>
</ul>
<h4 id="2-replay-buffer-必须存什么">2. Replay Buffer 必须存什么？</h4>
<ul>
<li><strong>问题</strong>：“PPO 的存储列表里，除了 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo separator="true">,</mo><mi>r</mi></mrow><annotation encoding="application/x-tex">s, a, r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span></span></span></span> 还要存什么？”</li>
<li><strong>必答项</strong>：<strong><code>old_log_prob</code></strong> (旧策略的对数概率)。</li>
<li><strong>原因</strong>：
<ul>
<li>计算 Ratio 公式需要：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>r</mi><mi>t</mi></msub><mo>=</mo><mfrac><mrow><mi>exp</mi><mo>⁡</mo><mo>(</mo><mi>log</mi><mo>⁡</mo><msub><mi>π</mi><mrow><mi>n</mi><mi>e</mi><mi>w</mi></mrow></msub><mo>)</mo></mrow><mrow><mi>exp</mi><mo>⁡</mo><mo>(</mo><mi>log</mi><mo>⁡</mo><msub><mi>π</mi><mrow><mi>o</mi><mi>l</mi><mi>d</mi></mrow></msub><mo>)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">r_t = \frac{\exp(\log\pi_{new})}{\exp(\log\pi_{old})}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.53em;vertical-align:-0.52em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.01em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight">exp</span><span class="mopen mtight">(</span><span class="mop mtight">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace mtight" style="margin-right:0.19516666666666668em;"></span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.485em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight">exp</span><span class="mopen mtight">(</span><span class="mop mtight">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace mtight" style="margin-right:0.19516666666666668em;"></span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285719em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.52em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>。</li>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>log</mi><mo>⁡</mo><msub><mi>π</mi><mrow><mi>n</mi><mi>e</mi><mi>w</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\log\pi_{new}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 是当前网络现算的。</li>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>log</mi><mo>⁡</mo><msub><mi>π</mi><mrow><mi>o</mi><mi>l</mi><mi>d</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\log\pi_{old}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 是<strong>历史数据</strong>。当网络参数更新后，你就再也算不出当时的 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>log</mi><mo>⁡</mo><msub><mi>π</mi><mrow><mi>o</mi><mi>l</mi><mi>d</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\log\pi_{old}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 了（因为网络变了）。所以必须在采样的时候就把它**“死死地记在小本本上”**。</li>
</ul>
</li>
<li><strong>其他</strong>：<code>value</code> (Critic 的预测值) 通常也需要存，为了算 GAE。</li>
</ul>
<hr>
<h3 id="第三板块系统设计-llm-rlhf-岗位必问">第三板块：系统设计 (LLM RLHF 岗位必问)</h3>
<p>如果你去面大模型相关的岗位，这部分是决定你是否 Senior 的关键。</p>
<h4 id="1-actor-和-critic-怎么切分分布式训练">1. Actor 和 Critic 怎么切分？(分布式训练)</h4>
<ul>
<li><strong>背景</strong>：LLM 很大（比如 7B, 70B），单张显卡放不下。</li>
<li><strong>答案</strong>：在 RLHF 阶段，其实涉及到 <strong>4 个模型</strong>：
<ol>
<li><strong>Actor</strong> (你要训练的 LLM)</li>
<li><strong>Critic</strong> (评判的 LLM)</li>
<li><strong>Ref Model</strong> (参考模型，通常是 SFT 后的冻结模型，用于算 KL 散度)</li>
<li><strong>Reward Model</strong> (奖励模型，给句子打分)</li>
</ol>
</li>
<li><strong>切分策略</strong>：
<ul>
<li><strong>参数冻结</strong>：Ref Model 和 Reward Model 是<strong>不更新参数</strong>的，通常可以用半精度 (fp16/bf16) 甚至量化 (int8) 放在显存里，或者多卡推理。</li>
<li><strong>Colocation (共置)</strong>：如果模型小，Actor 和 Critic 可以共享部分主干参数 (Shared Backbone)，只在最后分叉。但在 LLM 里通常是分开的。</li>
<li><strong>Offload</strong>：Critic 更新频率低或者不需要实时梯度回传给 Actor 的部分，可以切分到不同的 GPU 组上。</li>
</ul>
</li>
</ul>
<h4 id="2-kl-散度爆炸-kl-explosion">2. KL 散度爆炸 (KL Explosion)</h4>
<ul>
<li><strong>现象</strong>：模型为了拿高分，开始输出乱码（Reward Hacking）。虽然奖励模型给分高，但人看不懂。这时候它和 Ref Model 的 KL 散度会飙升。</li>
<li><strong>解决方法</strong>：
<ul>
<li><strong>KL Penalty</strong>：在 Reward 里强行减去 KL 值。 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>R</mi><mrow><mi>t</mi><mi>o</mi><mi>t</mi><mi>a</mi><mi>l</mi></mrow></msub><mo>=</mo><msub><mi>R</mi><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi></mrow></msub><mo>−</mo><mi>β</mi><mo>×</mo><msub><mi>D</mi><mrow><mi>K</mi><mi>L</mi></mrow></msub><mo>(</mo><mi>π</mi><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi><msub><mi>π</mi><mrow><mi>r</mi><mi>e</mi><mi>f</mi></mrow></msub><mo>)</mo></mrow><annotation encoding="application/x-tex">R_{total} = R_{model} - \beta \times D_{KL}(\pi || \pi_{ref})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">m</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">d</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.05278em;">β</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.07153em;">K</span><span class="mord mathdefault mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="mord">∣</span><span class="mord">∣</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.10764em;">f</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>。</li>
<li><strong>Early Stopping</strong>：如果监测到 KL 超过某个阈值，提前结束这一轮训练。</li>
<li><strong>PPO Clip</strong>：本身也有抑制作用。</li>
</ul>
</li>
</ul>
<h4 id="3-显存不够怎么办oom">3. 显存不够怎么办？(OOM)</h4>
<ul>
<li>这是工程必答题。关键词如下：
<ul>
<li><strong>ZeRO (Zero Redundancy Optimizer)</strong>：这是 DeepSpeed 的核心。它把优化器状态 (Optimizer States)、梯度 (Gradients)、参数 (Parameters) 切碎了存在不同的卡上，用的时候再通讯拼起来。<strong>必背！</strong></li>
<li><strong>Gradient Checkpointing</strong>：用“时间换空间”。不存中间层的激活值，反向传播时重新算一遍。能省 70% 显存。</li>
<li><strong>LoRA (Low-Rank Adaptation)</strong>：不训练整个 Actor，只训练在这个大模型旁边的“小挂件”矩阵。显存占用极低。</li>
<li><strong>Offload</strong>：把暂时不用的参数搬到 CPU 内存里去（慢，但是能跑）。</li>
</ul>
</li>
</ul>
<hr>
<h3 id="总结你的面试话术">总结你的“面试话术”</h3>
<p>当面试官问你：“你对 PPO 还有什么理解？” 或者问到上述细节时，你可以这样组织语言：</p>
<blockquote>
<p>“在实现 PPO 时，除了核心的 Clip 机制，为了保证收敛，我特别注意了<strong>数值稳定性</strong>。</p>
<p>比如在<strong>数据处理</strong>上，我用了 <strong>Advantage Normalization</strong> 来归一化优势值，防止梯度方差过大。</p>
<p>在<strong>网络设计</strong>上，我使用了<strong>正交初始化</strong>来避免长序列下的梯度消失。</p>
<p>另外，关于 <strong>On-policy</strong> 的特性，我理解关键在于 Replay Buffer 中的 <strong><code>old_log_prob</code></strong>。因为一旦参数更新，旧概率就无法复现，所以必须在采样阶段就把它固化下来，这也决定了 PPO 的数据利用率不如 Off-policy 算法高，但胜在稳定性好。</p>
<p>如果是在 <strong>LLM 分布式场景</strong>下，我也了解需要通过 <strong>ZeRO</strong> 等技术来解决 4 个模型同时存在的显存压力问题。”</p>
</blockquote>
<p>这一套说下来，面试官基本就觉得你很稳了。</p>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li><a href="#ppo-%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0%E4%B8%8E%E5%AE%9E%E6%88%98%E6%89%8B%E5%86%8C">PPO 算法学习与实战手册</a>
<ul>
<li><a href="#%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5%E4%B8%89%E4%B8%AA%E6%A0%B8%E5%BF%83%E8%A7%92%E8%89%B2%E5%85%88%E9%AA%8C%E7%9F%A5%E8%AF%86">第一阶段：三个核心角色（先验知识）</a>
<ul>
<li><a href="#1-actor%E6%BC%94%E5%91%98%E7%AD%96%E7%95%A5%E5%B0%B1%E6%98%AF%E4%BD%A0">1. Actor（演员/策略）：就是“你”</a></li>
<li><a href="#2-critic%E8%AF%84%E8%AE%BA%E5%AE%B6%E4%BB%B7%E5%80%BC%E5%B0%B1%E6%98%AF%E6%95%99%E7%BB%83">2. Critic（评论家/价值）：就是“教练”</a></li>
<li><a href="#3-advantage%E4%BC%98%E5%8A%BF%E5%B0%B1%E6%98%AF%E6%83%8A%E5%96%9C%E6%84%9F">3. Advantage（优势）：就是“惊喜感”</a></li>
</ul>
</li>
<li><a href="#%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5ppo-%E5%88%B0%E5%BA%95%E8%A7%A3%E5%86%B3%E4%BA%86%E4%BB%80%E4%B9%88%E9%97%AE%E9%A2%98">第二阶段：PPO 到底解决了什么问题？</a></li>
<li><a href="#%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5ppo-%E7%9A%84%E6%A0%B8%E5%BF%83%E9%98%B2%E6%9A%B4%E8%B5%B0%E6%9C%BA%E5%88%B6clipping">第三阶段：PPO 的核心“防暴走”机制（Clipping）</a></li>
<li><a href="#%E7%AC%AC%E5%9B%9B%E9%98%B6%E6%AE%B5%E4%BB%8A%E5%A4%A9%E7%9A%84%E4%BB%A3%E7%A0%81%E4%BB%BB%E5%8A%A1%E6%B5%81%E7%A8%8Balgorithm-1">第四阶段：今天的代码任务流程（Algorithm 1）</a></li>
<li><a href="#%E5%85%AC%E5%BC%8F%E8%AF%A6%E8%A7%A3%E7%AF%87%E5%B8%A6%E6%95%B0%E5%AD%97%E7%9A%84%E4%BE%8B%E5%AD%90">公式详解篇：带数字的例子</a>
<ul>
<li><a href="#%E7%AC%AC%E4%B8%80%E5%85%B3%E6%AF%94%E7%8E%87%E5%85%AC%E5%BC%8F-the-ratio">第一关：比率公式 (The Ratio)</a></li>
<li><a href="#%E7%AC%AC%E4%BA%8C%E5%85%B3%E6%88%AA%E6%96%AD%E7%9B%AE%E6%A0%87%E5%87%BD%E6%95%B0-clipped-objective-%E6%A0%B8%E5%BF%83%E4%B8%AD%E7%9A%84%E6%A0%B8%E5%BF%83">第二关：截断目标函数 (Clipped Objective) —— 核心中的核心</a></li>
<li><a href="#%E7%AC%AC%E4%B8%89%E5%85%B3%E6%80%BB%E6%8D%9F%E5%A4%B1%E5%87%BD%E6%95%B0-total-loss">第三关：总损失函数 (Total Loss)</a></li>
</ul>
</li>
<li><a href="#%E4%BC%98%E5%8A%BF%E5%87%BD%E6%95%B0-gae-%E8%AF%A6%E8%A7%A3">优势函数 (GAE) 详解</a>
<ul>
<li><a href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%E7%90%86%E8%A7%A3%E5%8D%95%E6%AD%A5%E6%83%8A%E5%96%9C-delta_t-td-error">第一步：理解“单步惊喜” (<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>δ</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">\delta_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03785em;">δ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>) —— TD Error</a></li>
<li><a href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%E7%90%86%E8%A7%A3%E5%A4%9A%E6%AD%A5%E8%BF%9E%E9%94%81-gae-lambda-%E7%9A%84%E9%AD%94%E6%B3%95">第二步：理解“多步连锁” (GAE) —— <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>λ</mi></mrow><annotation encoding="application/x-tex">\lambda</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">λ</span></span></span></span> 的魔法</a></li>
<li><a href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%E6%89%8B%E5%8A%A8%E7%AE%97%E4%B8%80%E9%81%8D%E4%BB%A3%E7%A0%81%E9%80%BB%E8%BE%91">第三步：手动算一遍（代码逻辑）</a></li>
</ul>
</li>
<li><a href="#%E4%BB%A3%E7%A0%81%E5%88%87%E7%89%87%E8%AF%A6%E8%A7%A3%E8%BE%93%E5%85%A5-%E5%A4%84%E7%90%86-%E8%BE%93%E5%87%BA">代码切片详解：输入-&gt;处理-&gt;输出</a>
<ul>
<li><a href="#%E7%AC%AC%E4%B8%80%E5%88%87%E7%89%87%E5%8A%A8%E4%BD%9C%E9%80%89%E6%8B%A9-sampling">第一切片：动作选择 (Sampling)</a></li>
<li><a href="#%E7%AC%AC%E4%BA%8C%E5%88%87%E7%89%87%E4%BC%98%E5%8A%BF%E8%AE%A1%E7%AE%97-gae-calculation">第二切片：优势计算 (GAE Calculation)</a></li>
<li><a href="#%E7%AC%AC%E4%B8%89%E5%88%87%E7%89%87%E7%BD%91%E7%BB%9C%E6%9B%B4%E6%96%B0-optimization-loop">第三切片：网络更新 (Optimization Loop)</a></li>
</ul>
</li>
<li><a href="#%E6%80%BB%E7%BB%93%E5%85%A8%E5%9B%BE">总结全图</a></li>
<li><a href="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81-%E5%9F%BA%E4%BA%8E-gymnasium">完整代码 (基于 Gymnasium)</a>
<ul>
<li><a href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C%E6%97%A5%E5%BF%97">运行结果日志</a></li>
<li><a href="#1-%E6%95%B0%E5%AD%A6%E5%8E%9F%E7%90%86%E5%AF%B9%E6%95%B0%E6%80%A7%E8%B4%A8">1. 数学原理：对数性质</a></li>
<li><a href="#2-%E5%B7%A5%E7%A8%8B%E5%8E%9F%E5%9B%A0%E6%95%B0%E5%80%BC%E7%A8%B3%E5%AE%9A%E6%80%A7-numerical-stability">2. 工程原因：数值稳定性 (Numerical Stability)</a>
<ul>
<li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E6%A6%82%E7%8E%87%E5%BE%88%E5%8D%B1%E9%99%A9">为什么概率很危险？</a></li>
<li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E5%AF%B9%E6%95%B0%E5%BE%88%E5%AE%89%E5%85%A8">为什么对数很安全？</a></li>
</ul>
</li>
<li><a href="#1-%E5%BD%A2%E7%8A%B6%E7%9A%84%E5%8F%98%E5%8C%96%E4%BB%8E%E4%B8%80%E5%88%97%E6%95%B0%E5%8F%98%E6%88%90%E4%B8%80%E4%B8%AA%E6%95%B0">1. 形状的变化：从“一列数”变成“一个数”</a></li>
<li><a href="#2-%E6%A2%AF%E5%BA%A6%E7%9A%84%E7%A8%B3%E5%AE%9A%E6%80%A7%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81-mean-%E4%B8%8D%E8%A6%81-sum">2. 梯度的稳定性（为什么要 Mean 不要 Sum？）</a></li>
<li><a href="#3-%E6%95%B0%E5%AD%A6%E5%90%AB%E4%B9%89%E6%9C%9F%E6%9C%9Bexpectation">3. 数学含义：期望（Expectation）</a></li>
<li><a href="#1-%E6%95%B0%E5%AD%A6%E5%85%AC%E5%BC%8F%E8%BF%98%E5%8E%9F%E7%9C%9F%E7%9B%B8">1. 数学公式：还原真相</a></li>
<li><a href="#2-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E8%BF%98%E5%8E%9F%E7%BB%99-critic-%E7%9C%8B">2. 为什么要还原？（给 Critic 看）</a></li>
<li><a href="#3-%E4%BB%A3%E7%A0%81%E4%B8%AD%E7%9A%84%E5%8E%BB%E5%90%91">3. 代码中的去向</a></li>
<li><a href="#%E6%80%BB%E7%BB%93">总结</a></li>
<li><a href="#%E7%AC%AC%E4%B8%80%E6%9D%BF%E5%9D%97%E5%B8%B8%E8%A7%81-trick-%E8%80%83%E5%AF%9F-why-how">第一板块：常见 Trick 考察 (Why &amp; How)</a>
<ul>
<li><a href="#1-advantage-normalization-%E4%BC%98%E5%8A%BF%E5%BD%92%E4%B8%80%E5%8C%96">1. Advantage Normalization (优势归一化)</a></li>
<li><a href="#2-orthogonal-initialization-%E6%AD%A3%E4%BA%A4%E5%88%9D%E5%A7%8B%E5%8C%96">2. Orthogonal Initialization (正交初始化)</a></li>
<li><a href="#3-gradient-clipping-%E6%A2%AF%E5%BA%A6%E8%A3%81%E5%89%AA">3. Gradient Clipping (梯度裁剪)</a></li>
<li><a href="#4-learning-rate-decay-%E5%AD%A6%E4%B9%A0%E7%8E%87%E8%A1%B0%E5%87%8F">4. Learning Rate Decay (学习率衰减)</a></li>
<li><a href="#5-log_prob-%E7%9A%84%E6%95%B0%E5%80%BC%E7%A8%B3%E5%AE%9A%E6%80%A7">5. Log_prob 的数值稳定性</a></li>
</ul>
</li>
<li><a href="#%E7%AC%AC%E4%BA%8C%E6%9D%BF%E5%9D%97on-policy-vs-off-policy-%E6%A6%82%E5%BF%B5%E6%B7%B1%E6%8C%96">第二板块：On-policy vs Off-policy (概念深挖)</a>
<ul>
<li><a href="#1-ppo-%E4%B8%BA%E4%BB%80%E4%B9%88%E6%98%AF-on-policy-%E7%9A%84">1. PPO 为什么是 On-policy 的？</a></li>
<li><a href="#2-replay-buffer-%E5%BF%85%E9%A1%BB%E5%AD%98%E4%BB%80%E4%B9%88">2. Replay Buffer 必须存什么？</a></li>
</ul>
</li>
<li><a href="#%E7%AC%AC%E4%B8%89%E6%9D%BF%E5%9D%97%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1-llm-rlhf-%E5%B2%97%E4%BD%8D%E5%BF%85%E9%97%AE">第三板块：系统设计 (LLM RLHF 岗位必问)</a>
<ul>
<li><a href="#1-actor-%E5%92%8C-critic-%E6%80%8E%E4%B9%88%E5%88%87%E5%88%86%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%AD%E7%BB%83">1. Actor 和 Critic 怎么切分？(分布式训练)</a></li>
<li><a href="#2-kl-%E6%95%A3%E5%BA%A6%E7%88%86%E7%82%B8-kl-explosion">2. KL 散度爆炸 (KL Explosion)</a></li>
<li><a href="#3-%E6%98%BE%E5%AD%98%E4%B8%8D%E5%A4%9F%E6%80%8E%E4%B9%88%E5%8A%9Eoom">3. 显存不够怎么办？(OOM)</a></li>
</ul>
</li>
<li><a href="#%E6%80%BB%E7%BB%93%E4%BD%A0%E7%9A%84%E9%9D%A2%E8%AF%95%E8%AF%9D%E6%9C%AF">总结你的“面试话术”</a></li>
</ul>
</li>
</ul>
</li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">下一篇</div>
            <a href="https://Alive-mk.github.io/post/han-jia-ji-hua/">
              <h3 class="post-title">
                寒假计划
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
  <a class="rss" href="https://Alive-mk.github.io/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
