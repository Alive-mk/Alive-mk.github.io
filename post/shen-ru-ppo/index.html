<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>深入PPO | Alive-mk</title>
<link rel="shortcut icon" href="https://Alive-mk.github.io/favicon.ico?v=1770951170092">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://Alive-mk.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="深入PPO | Alive-mk - Atom Feed" href="https://Alive-mk.github.io/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="1. 核心概念与论文溯源 (Concept &amp; Paper Roots)
论文引用

核心论文：Proximal Policy Optimization Algorithms (Schulman et al., 2017)
RLHF..." />
    <meta name="keywords" content="实习" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://Alive-mk.github.io">
  <img class="avatar" src="https://Alive-mk.github.io/images/avatar.png?v=1770951170092" alt="">
  </a>
  <h1 class="site-title">
    Alive-mk
  </h1>
  <p class="site-description">
    温故而知新
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          首页
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              深入PPO
            </h2>
            <div class="post-info">
              <span>
                2026-02-02
              </span>
              <span>
                29 min read
              </span>
              
                <a href="https://Alive-mk.github.io/tag/pt1Ejsp1Pa/" class="post-tag">
                  # 实习
                </a>
              
            </div>
            
            <div class="post-content-wrapper">
              <div class="post-content" v-pre>
                <h3 id="1-核心概念与论文溯源-concept-paper-roots">1. 核心概念与论文溯源 (Concept &amp; Paper Roots)</h3>
<h4 id="论文引用"><strong>论文引用</strong></h4>
<ul>
<li><strong>核心论文</strong>：<a href="https://arxiv.org/abs/1707.06347">Proximal Policy Optimization Algorithms (Schulman et al., 2017)</a></li>
<li><strong>RLHF 应用背景</strong>：<a href="https://arxiv.org/abs/2203.02155">Training language models to follow instructions with human feedback (InstructGPT, OpenAI, 2022)</a></li>
</ul>
<h4 id="本质概括"><strong>本质概括</strong></h4>
<p>PPO 的本质是在<strong>信任区域（Trust Region）</strong> 思想下的<strong>一阶近似</strong>优化方法。它通过 Clipping（截断）机制限制新旧策略（Policy）的更新步长，在保证训练稳定性的前提下，最大化“悲观”的代理目标函数（Surrogate Objective）。</p>
<h4 id="痛点解决"><strong>痛点解决</strong></h4>
<ul>
<li><strong>解决 Vanilla Policy Gradient (PG) 的不稳定性</strong>：普通 PG 对学习率极度敏感，一步更新过大可能导致策略崩溃且无法恢复。</li>
<li><strong>解决 TRPO (Trust Region Policy Optimization) 的计算复杂度</strong>：TRPO 需要计算 Hessian 矩阵的逆（二阶优化），在深度神经网络中极其昂贵。PPO 用简单的 <code>clip</code> 操作近似了 TRPO 的 KL 散度约束，<strong>将二阶约束转化为一阶计算</strong>，极大降低了计算量。</li>
<li><strong>RLHF 场景痛点</strong>：在 LLM 中，模型极易出现“Reward Hacking”（为了高分输出乱码）。PPO 结合 KL 惩罚项（KL Penalty），强制模型不偏离 Reference Model 太远。</li>
</ul>
<hr>
<h3 id="2-数学原理与推导-mathematical-underpinning">2. 数学原理与推导 (Mathematical Underpinning)</h3>
<p>在 <code>trl</code> 的源码实现中，<code>step</code> 函数的核心是计算 PPO-Clip Loss。</p>
<h4 id="核心公式clipped-surrogate-objective"><strong>核心公式：Clipped Surrogate Objective</strong></h4>
<p>PPO 试图最大化以下目标函数：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>L</mi><mrow><mi>C</mi><mi>L</mi><mi>I</mi><mi>P</mi></mrow></msup><mo>(</mo><mi>θ</mi><mo>)</mo><mo>=</mo><msub><mover accent="true"><mi mathvariant="double-struck">E</mi><mo>^</mo></mover><mi>t</mi></msub><mrow><mo fence="true">[</mo><mi>min</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><msub><mi>r</mi><mi>t</mi></msub><mo>(</mo><mi>θ</mi><mo>)</mo><msub><mover accent="true"><mi>A</mi><mo>^</mo></mover><mi>t</mi></msub><mo separator="true">,</mo><mtext>clip</mtext><mo>(</mo><msub><mi>r</mi><mi>t</mi></msub><mo>(</mo><mi>θ</mi><mo>)</mo><mo separator="true">,</mo><mn>1</mn><mo>−</mo><mi>ϵ</mi><mo separator="true">,</mo><mn>1</mn><mo>+</mo><mi>ϵ</mi><mo>)</mo><msub><mover accent="true"><mi>A</mi><mo>^</mo></mover><mi>t</mi></msub><mo fence="true">)</mo></mrow><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">L^{CLIP}(\theta) = \hat{\mathbb{E}}_t \left[ \min \left( r_t(\theta)\hat{A}_t, \text{clip}(r_t(\theta), 1-\epsilon, 1+\epsilon)\hat{A}_t \right) \right]
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1413309999999999em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.07153em;">C</span><span class="mord mathdefault mtight">L</span><span class="mord mathdefault mtight" style="margin-right:0.07847em;">I</span><span class="mord mathdefault mtight" style="margin-right:0.13889em;">P</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.80002em;vertical-align:-0.65002em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9523299999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span></span></span><span style="top:-3.25789em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.16666em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">[</span></span><span class="mop">min</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9467699999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.11110999999999999em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">clip</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">ϵ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">ϵ</span><span class="mclose">)</span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9467699999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.11110999999999999em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">]</span></span></span></span></span></span></span></p>
<p>其中：</p>
<ul>
<li><strong><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">θ</span></span></span></span></strong>：当前策略网络的参数。</li>
<li><strong><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>r</mi><mi>t</mi></msub><mo>(</mo><mi>θ</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">r_t(\theta)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span></span></span></span></strong>：概率比率（Importance Sampling Ratio），即 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mfrac><mrow><msub><mi>π</mi><mi>θ</mi></msub><mo>(</mo><msub><mi>a</mi><mi>t</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>s</mi><mi>t</mi></msub><mo>)</mo></mrow><mrow><msub><mi>π</mi><msub><mi>θ</mi><mrow><mi>o</mi><mi>l</mi><mi>d</mi></mrow></msub></msub><mo>(</mo><msub><mi>a</mi><mi>t</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>s</mi><mi>t</mi></msub><mo>)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{\pi_\theta(a_t|s_t)}{\pi_{\theta_{old}}(a_t|s_t)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.6356799999999998em;vertical-align:-0.6256799999999999em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.01em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.34480000000000005em;"><span style="top:-2.3487714285714287em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3448em;margin-left:-0.02778em;margin-right:0.1em;"><span class="pstrut" style="height:2.69444em;"></span><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.34963999999999995em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4009714285714285em;"><span></span></span></span></span></span></span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.29634285714285713em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mord mtight">∣</span><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.29634285714285713em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.485em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.29634285714285713em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mord mtight">∣</span><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.29634285714285713em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.6256799999999999em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>。</li>
<li><strong><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mover accent="true"><mi>A</mi><mo>^</mo></mover><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">\hat{A}_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0967699999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9467699999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.11110999999999999em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></strong>：优势函数（Advantage），通常使用 GAE (Generalized Advantage Estimation) 计算。</li>
<li><strong><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">ϵ</span></span></span></span></strong>：超参数（通常为 0.2），限制更新幅度。</li>
</ul>
<h4 id="rlhf-中的总-loss"><strong>RLHF 中的总 Loss</strong></h4>
<p>在 <code>DeepSpeed-Chat</code> 或 <code>trl</code> 中，最终的 Loss 通常包含三部分：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>L</mi><mrow><mi>t</mi><mi>o</mi><mi>t</mi><mi>a</mi><mi>l</mi></mrow></msub><mo>=</mo><mo>−</mo><msup><mi>L</mi><mrow><mi>C</mi><mi>L</mi><mi>I</mi><mi>P</mi></mrow></msup><mo>(</mo><mi>θ</mi><mo>)</mo><mo>+</mo><msub><mi>c</mi><mn>1</mn></msub><msup><mi>L</mi><mrow><mi>V</mi><mi>F</mi></mrow></msup><mo>(</mo><mi>ϕ</mi><mo>)</mo><mo>−</mo><msub><mi>c</mi><mn>2</mn></msub><mi>S</mi><mo>[</mo><msub><mi>π</mi><mi>θ</mi></msub><mo>]</mo><mo>(</mo><msub><mi>s</mi><mi>t</mi></msub><mo>)</mo></mrow><annotation encoding="application/x-tex">L_{total} = - L^{CLIP}(\theta) + c_1 L^{VF}(\phi) - c_2 S[\pi_\theta](s_t)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.1413309999999999em;vertical-align:-0.25em;"></span><span class="mord">−</span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.07153em;">C</span><span class="mord mathdefault mtight">L</span><span class="mord mathdefault mtight" style="margin-right:0.07847em;">I</span><span class="mord mathdefault mtight" style="margin-right:0.13889em;">P</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1413309999999999em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.22222em;">V</span><span class="mord mathdefault mtight" style="margin-right:0.13889em;">F</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">ϕ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mopen">[</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p>或者更常见的 InstructGPT 形式（将 KL 放入 Reward 或作为单独项）：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>L</mi><mrow><mi>t</mi><mi>o</mi><mi>t</mi><mi>a</mi><mi>l</mi></mrow></msub><mo>=</mo><mo>−</mo><msubsup><mi>L</mi><mrow><mi>p</mi><mi>o</mi><mi>l</mi><mi>i</mi><mi>c</mi><mi>y</mi></mrow><mrow><mi>C</mi><mi>L</mi><mi>I</mi><mi>P</mi></mrow></msubsup><mo>+</mo><msub><mi>λ</mi><mrow><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi></mrow></msub><msub><mi>L</mi><mrow><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi></mrow></msub><mo>+</mo><msub><mi>λ</mi><mrow><mi>e</mi><mi>n</mi><mi>t</mi><mi>r</mi><mi>o</mi><mi>p</mi><mi>y</mi></mrow></msub><msub><mi>L</mi><mrow><mi>e</mi><mi>n</mi><mi>t</mi><mi>r</mi><mi>o</mi><mi>p</mi><mi>y</mi></mrow></msub></mrow><annotation encoding="application/x-tex">L_{total} = - L^{CLIP}_{policy} + \lambda_{value} L_{value} + \lambda_{entropy} L_{entropy}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.274439em;vertical-align:-0.383108em;"></span><span class="mord">−</span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.891331em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">c</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span><span style="top:-3.1130000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.07153em;">C</span><span class="mord mathdefault mtight">L</span><span class="mord mathdefault mtight" style="margin-right:0.07847em;">I</span><span class="mord mathdefault mtight" style="margin-right:0.13889em;">P</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">λ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">u</span><span class="mord mathdefault mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">u</span><span class="mord mathdefault mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">λ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.28055599999999997em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.28055599999999997em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p><em>注意：在 <code>trl</code> 的实现中，KL 散度通常已经预先计算并加到了 Reward 中，或者作为辅助 Loss。</em></p>
<h4 id="梯度的直觉"><strong>梯度的直觉</strong></h4>
<ul>
<li>当 Advantage <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mover accent="true"><mi>A</mi><mo>^</mo></mover><mi>t</mi></msub><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\hat{A}_t &gt; 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0967699999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9467699999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.11110999999999999em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>（动作好）：我们希望增加该动作概率，即 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>r</mi><mi>t</mi></msub><mo>(</mo><mi>θ</mi><mo>)</mo><mo>&gt;</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">r_t(\theta) &gt; 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>。但如果增加太多（超过 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mo>+</mo><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">1+\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">ϵ</span></span></span></span>），梯度会被截断为 0，停止更新。这防止了“过度自信”。</li>
<li>当 Advantage <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mover accent="true"><mi>A</mi><mo>^</mo></mover><mi>t</mi></msub><mo>&lt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\hat{A}_t &lt; 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0967699999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9467699999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.11110999999999999em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>（动作差）：我们希望减少概率。同样，如果减少太剧烈（低于 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mo>−</mo><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">1-\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">ϵ</span></span></span></span>），也会截断。</li>
</ul>
<hr>
<h3 id="3-手撕代码重点与实现-whiteboard-coding-focus">3. 手撕代码重点与实现 (Whiteboard Coding Focus)</h3>
<p>在面试中，你不需要写完整个 Trainer，但<strong>必须能够默写 Loss 计算的核心逻辑</strong>。</p>
<p><strong>面试场景</strong>：面试官通常会问：“在 <code>step</code> 函数内部，拿到 batch 数据后，Loss 是怎么算的？请写出 PPO Loss 的实现。”</p>
<h4 id="核心逻辑必须死记硬背的部分"><strong>核心逻辑（必须死记硬背的部分）</strong></h4>
<ol>
<li><strong>Logprobs 到 Ratio 的转换</strong>：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>log</mi><mo>⁡</mo><mo>(</mo><mi>a</mi><mo>)</mo><mo>−</mo><mi>log</mi><mo>⁡</mo><mo>(</mo><mi>b</mi><mo>)</mo><mo>=</mo><mi>log</mi><mo>⁡</mo><mo>(</mo><mi>a</mi><mi mathvariant="normal">/</mi><mi>b</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">\log(a) - \log(b) = \log(a/b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord mathdefault">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mord">/</span><span class="mord mathdefault">b</span><span class="mclose">)</span></span></span></span>，所以 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>r</mi><mi>t</mi></msub><mo>(</mo><mi>θ</mi><mo>)</mo><mo>=</mo><mi>exp</mi><mo>⁡</mo><mo>(</mo><mtext>new_logprobs</mtext><mo>−</mo><mtext>old_logprobs</mtext><mo>)</mo></mrow><annotation encoding="application/x-tex">r_t(\theta) = \exp(\text{new\_logprobs} - \text{old\_logprobs})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span><span class="mop">exp</span><span class="mopen">(</span><span class="mord text"><span class="mord">new_logprobs</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span><span class="mord text"><span class="mord">old_logprobs</span></span><span class="mclose">)</span></span></span></span>。<strong>千万别直接除概率，数值不稳定。</strong></li>
<li><strong>Clipping</strong>：使用 <code>torch.clamp</code>。</li>
<li><strong>取最小值</strong>：实现“悲观”估计。</li>
</ol>
<h4 id="python-代码实现-基于-pytorchtrl-风格"><strong>Python 代码实现 (基于 PyTorch/trl 风格)</strong></h4>
<pre><code>import torch
import torch.nn as nn
import torch.nn.functional as F

def ppo_loss_step(
    old_logprobs,       # 旧策略产生的 log 概率 (Detached)
    values,             # 价值网络预测的 Value
    rewards,            # 真实 Reward (包含 KL 惩罚)
    logits,             # 当前策略网络的输出 Logits
    attention_mask,     # Mask，处理 Padding
    actions,            # 实际采取的 Token ID
    gamma=0.99,         # GAE 参数
    lam=0.95,           # GAE 参数
    cliprange=0.2,      # PPO Clip 参数
    value_loss_coef=0.1 # Value Loss 系数
):
    # 1. 获取当前策略的 Logprobs
    # logits shape: [batch, seq_len, vocab_size]
    # actions shape: [batch, seq_len]
    logprobs = torch.gather(
        F.log_softmax(logits, dim=-1), 
        dim=-1, 
        index=actions.unsqueeze(-1)
    ).squeeze(-1)
    
    # 2. 计算优势函数 (Advantage) - GAE
    # 注意：在 trl 中，通常在 rollout 阶段就已经算好了 advantages 并传入
    # 这里为了完整性展示 GAE 逻辑，实际 step 中可能直接传入 advantages
    # advantages = compute_gae(rewards, values, gamma, lam) &lt;-- 面试时这一行可以伪代码
    
    # 假设 advantages 已经传入且归一化 (Normalization is crucial!)
    # advantages = (advantages - advantages.mean()) / (advantages.std() + 1e-8)

    # 3. 计算 Ratio (核心！)
    # r_t = pi_new / pi_old = exp(log_pi_new - log_pi_old)
    ratio = torch.exp(logprobs - old_logprobs)

    # 4. 计算 Surrogate Loss (核心！)
    pg_losses = -advantages * ratio
    pg_losses2 = -advantages * torch.clamp(ratio, 1.0 - cliprange, 1.0 + cliprange)
    
    # 取 max 因为我们加了负号（原公式是 maximize min，现在是 minimize max）
    policy_loss = torch.max(pg_losses, pg_losses2).mean()

    # 5. 计算 Value Loss (Critic)
    # 简单的 MSE Loss，有时也会对 Value 做 Clip
    # returns = advantages + old_values
    # value_loss = F.mse_loss(values, returns)
    
    return policy_loss # (+ value_loss * value_loss_coef)
</code></pre>
<h4 id="工程落地细节-production-nuances"><strong>工程落地细节 (Production Nuances)</strong></h4>
<ul>
<li><strong>Advantage Normalization</strong>：在每个 mini-batch 或整个 batch 上对 Advantage 进行标准化（减均值除方差）是<strong>极其重要</strong>的 Trick，能显著加快收敛。</li>
<li><strong>Masking</strong>：在处理文本生成时，Padding Token 的 Loss 必须被 Mask 掉，否则会干扰梯度。</li>
<li><strong>Numerical Stability</strong>：始终在 Log 空间操作概率，最后再 exp 计算 ratio。</li>
<li><strong>Value Function Clipping</strong>：<code>trl</code> 和 <code>DeepSpeed</code> 实现中，不仅对 Policy Clip，通常也会对 Value Function 的更新进行 Clip，防止 Critic 跑偏太远。</li>
</ul>
<blockquote>
<p>这四个点是 RLHF 工程落地中<strong>区分“调包侠”和“资深算法工程师”的分水岭</strong>。在面试中，面试官问这些细节，通常是为了确认你是否真的读懂了 <code>trl</code> 或 <code>DeepSpeed</code> 的源码，以及你是否踩过模型不收敛的坑。</p>
<p>下面我将逐一拆解，提供<strong>源码级的深度解析</strong>。</p>
<hr>
<h3 id="1-advantage-normalization-优势函数标准化">1. Advantage Normalization (优势函数标准化)</h3>
<h4 id="底层逻辑与痛点"><strong>底层逻辑与痛点</strong></h4>
<p>在 PPO 中，Advantage <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mover accent="true"><mi>A</mi><mo>^</mo></mover><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">\hat{A}_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0967699999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9467699999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.11110999999999999em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 衡量的是“当前动作比平均水平好多少”。</p>
<ul>
<li><strong>痛点</strong>：Reward 的数值范围往往不可控。有时 Reward 是 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo>]</mo></mrow><annotation encoding="application/x-tex">[0, 1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span>，有时是 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>[</mo><mo>−</mo><mn>10</mn><mo separator="true">,</mo><mn>10</mn><mo>]</mo></mrow><annotation encoding="application/x-tex">[-10, 10]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">−</span><span class="mord">1</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mclose">]</span></span></span></span>。这会导致 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mover accent="true"><mi>A</mi><mo>^</mo></mover><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">\hat{A}_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0967699999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9467699999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.11110999999999999em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 的量级剧烈波动。如果不归一化，梯度的模长（Norm）会随 Reward 缩放，导致我们精心调节的学习率（Learning Rate）失效。</li>
<li><strong>数学本质</strong>：这是一种**白化（Whitening）**操作，将数据映射到 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>N</mi><mo>(</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo>)</mo></mrow><annotation encoding="application/x-tex">N(0, 1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span> 标准正态分布，确保优化地形（Optimization Landscape）的曲率均匀，使梯度下降更稳健。</li>
</ul>
<h4 id="源码实现-pytorch"><strong>源码实现 (PyTorch)</strong></h4>
<p><strong>面试考点</strong>：通常是在 mini-batch 级别做，还是在整个 epoch 级别做？（一般是 <strong>Mini-batch</strong>）。要注意分母加一个极小值 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">ϵ</span></span></span></span> 防止除零。</p>
<p>Python</p>
<pre><code>def normalize_advantages(advantages, epsilon=1e-8):
    # advantages shape: [batch_size, seq_len] (或者是展平后的 [batch_size * seq_len])
    
    # 1. 计算均值和方差
    # 注意：通常会对 Mask 掉 Padding 后的有效数据计算均值
    # 这里假设 advantages 已经是 valid tokens 的数据或者 mask 处理过了
    mean = advantages.mean()
    std = advantages.std()
    
    # 2. 标准化
    normalized_adv = (advantages - mean) / (std + epsilon)
    
    return normalized_adv
</code></pre>
<h4 id="工程细节"><strong>工程细节</strong></h4>
<p>在 <code>trl</code> 中，这个操作通常发生在 <code>trainer.py</code> 的计算 Loss 之前。如果不做这一步，PPO 的 Loss 曲线往往会震荡极大，甚至 KL 散度瞬间爆炸。</p>
<hr>
<h3 id="2-masking-padding-处理">2. Masking (Padding 处理)</h3>
<h4 id="底层逻辑与痛点-2"><strong>底层逻辑与痛点</strong></h4>
<p>LLM 训练通常使用 Batch 训练，长短不一的句子需要补零（Padding）。</p>
<ul>
<li><strong>痛点</strong>：如果不 Mask，Padding Token 会参与 Loss 计算。
<ul>
<li>Policy Loss：模型会尝试去优化“预测 Padding Token”的概率，这是无意义的。</li>
<li>Value Loss：Critic 会去拟合 Padding 的 Value（通常是0），这会拉低整个 Value 网络的均值估计。</li>
</ul>
</li>
<li><strong>Gradients</strong>：Padding 的梯度必须为 <strong>0</strong>，绝对不能回传。</li>
</ul>
<h4 id="代码实现-关键逻辑"><strong>代码实现 (关键逻辑)</strong></h4>
<p>这是面试手写 Loss 时的<strong>必查项</strong>。</p>
<p>Python</p>
<pre><code># 假设 input_ids 是 [batch, seq_len]
# attention_mask 是 [batch, seq_len]，1 为有效，0 为 Padding

# 计算 Policy Loss (未 reduce mean 之前)
# policy_loss_unmasked shape: [batch, seq_len]
policy_loss_unmasked = -advantages * torch.min(ratio, clamped_ratio)

# ★★★ 核心 Mask 操作 ★★★
# 1. 将 Padding 位置的 Loss 置为 0
policy_loss_masked = policy_loss_unmasked * attention_mask

# 2. 计算 Mean 时，分母必须是有效 Token 的数量，而不是总元素数
# sum() / sum(mask) 而不是 mean()
loss = policy_loss_masked.sum() / attention_mask.sum()
</code></pre>
<h4 id="面试深挖"><strong>面试深挖</strong></h4>
<p><strong>Q: 在计算 GAE (Generalized Advantage Estimation) 时，遇到 Padding 怎么办？</strong></p>
<p><strong>A:</strong> GAE 是递归计算的（依赖 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">t+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69841em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> 时刻的值）。如果一个 Sequence 结束了（到了 Padding），必须截断递归链，不能让 Padding 的 Value 污染前一个 Token 的 Advantage。一般通过 <code>sequence_end_mask</code> 来处理。</p>
<hr>
<h3 id="3-numerical-stability-数值稳定性-log-space">3. Numerical Stability (数值稳定性 - Log Space)</h3>
<h4 id="底层逻辑与痛点-3"><strong>底层逻辑与痛点</strong></h4>
<ul>
<li><strong>痛点</strong>：LLM 的词表（Vocab Size）通常很大（如 32k - 100k），单个 Token 的概率往往极小（例如 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>5</mn></mrow></msup></mrow><annotation encoding="application/x-tex">10^{-5}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">5</span></span></span></span></span></span></span></span></span></span></span></span>）。</li>
<li><strong>Ratio 计算风险</strong>：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>r</mi><mi>t</mi></msub><mo>(</mo><mi>θ</mi><mo>)</mo><mo>=</mo><mfrac><mrow><msub><mi>π</mi><mrow><mi>n</mi><mi>e</mi><mi>w</mi></mrow></msub><mo>(</mo><mi>a</mi><mi mathvariant="normal">∣</mi><mi>s</mi><mo>)</mo></mrow><mrow><msub><mi>π</mi><mrow><mi>o</mi><mi>l</mi><mi>d</mi></mrow></msub><mo>(</mo><mi>a</mi><mi mathvariant="normal">∣</mi><mi>s</mi><mo>)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">r_t(\theta) = \frac{\pi_{new}(a|s)}{\pi_{old}(a|s)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.53em;vertical-align:-0.52em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.01em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span><span class="mopen mtight">(</span><span class="mord mathdefault mtight">a</span><span class="mord mtight">∣</span><span class="mord mathdefault mtight">s</span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.485em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285719em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mopen mtight">(</span><span class="mord mathdefault mtight">a</span><span class="mord mtight">∣</span><span class="mord mathdefault mtight">s</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.52em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>。如果分母极小（接近下溢出），<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>r</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">r_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 会瞬间变成 Inf。</li>
<li><strong>解决方案</strong>：利用 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>log</mi><mo>⁡</mo><mo>(</mo><mi>a</mi><mi mathvariant="normal">/</mi><mi>b</mi><mo>)</mo><mo>=</mo><mi>log</mi><mo>⁡</mo><mi>a</mi><mo>−</mo><mi>log</mi><mo>⁡</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">\log(a/b) = \log a - \log b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mord">/</span><span class="mord mathdefault">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">a</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">b</span></span></span></span>。加减法在计算机浮点数运算中比乘除法极其稳定。</li>
</ul>
<h4 id="源码实现"><strong>源码实现</strong></h4>
<p>Python</p>
<pre><code># --- 错误示范 (Junior 写法) ---
# probs_new = torch.softmax(logits_new, dim=-1)
# probs_old = torch.softmax(logits_old, dim=-1)
# ratio = probs_new / probs_old  # &lt;--- 极易 NaN 或 Inf

# --- 正确示范 (Senior 写法) ---
# 1. 直接获取 Log Probability
# log_softmax 数值上比 log(softmax(x)) 更稳，PyTorch 内部有优化 (LogSumExp 技巧)
log_probs_new = F.log_softmax(logits_new, dim=-1)
log_probs_old = old_log_probs # 之前存下来的，不用重新算

# 2. 获取特定 Action 的 log_prob
# distinct action log probs
action_log_prob_new = torch.gather(log_probs_new, -1, actions.unsqueeze(-1)).squeeze(-1)

# 3. 在 Log 域做减法
log_ratio = action_log_prob_new - action_log_prob_old

# 4. 最后再 exp 还原回 ratio 用于 clip
ratio = torch.exp(log_ratio)
</code></pre>
<hr>
<h3 id="4-value-function-clipping-critic-裁剪">4. Value Function Clipping (Critic 裁剪)</h3>
<h4 id="底层逻辑与痛点-4"><strong>底层逻辑与痛点</strong></h4>
<p>这是 PPO 论文中提到但经常被初学者忽略的一个 Trick（OpenAI Baseline 代码中默认开启）。</p>
<ul>
<li><strong>痛点</strong>：Policy Network 限制了更新幅度（Clip），但 Critic Network 如果没有限制，可能会在一次更新中对 Value 估计发生剧烈变化。</li>
<li><strong>后果</strong>：Critic 波动大 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\to</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> Advantage 计算波动大 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\to</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">→</span></span></span></span> Policy 训练不稳定。我们希望 Critic 的更新也是“保守”的。</li>
</ul>
<h4 id="数学原理"><strong>数学原理</strong></h4>
<p>Critic 的 Loss 不仅仅是 MSE，而是带 Clip 的 MSE：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>L</mi><mrow><mi>V</mi><mi>F</mi></mrow></msup><mo>=</mo><mi>max</mi><mo>⁡</mo><mrow><mo fence="true">[</mo><mo>(</mo><msub><mi>V</mi><mi>ϕ</mi></msub><mo>(</mo><mi>s</mi><mo>)</mo><mo>−</mo><mi>R</mi><msup><mo>)</mo><mn>2</mn></msup><mo separator="true">,</mo><mspace width="1em"/><mo>(</mo><mtext>clip</mtext><mo>(</mo><msub><mi>V</mi><mi>ϕ</mi></msub><mo>(</mo><mi>s</mi><mo>)</mo><mo separator="true">,</mo><msub><mi>V</mi><mrow><mi>o</mi><mi>l</mi><mi>d</mi></mrow></msub><mo>−</mo><mi>ϵ</mi><mo separator="true">,</mo><msub><mi>V</mi><mrow><mi>o</mi><mi>l</mi><mi>d</mi></mrow></msub><mo>+</mo><mi>ϵ</mi><mo>)</mo><mo>−</mo><mi>R</mi><msup><mo>)</mo><mn>2</mn></msup><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">L^{VF} = \max \left[ (V_\phi(s) - R)^2, \quad (\text{clip}(V_\phi(s), V_{old} - \epsilon, V_{old} + \epsilon) - R)^2 \right]
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8913309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.22222em;">V</span><span class="mord mathdefault mtight" style="margin-right:0.13889em;">F</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.2141179999999998em;vertical-align:-0.35001em;"></span><span class="mop">max</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">[</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">ϕ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace" style="margin-right:1em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">clip</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">ϕ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">ϵ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">ϵ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">]</span></span></span></span></span></span></span></p>
<p>这意味着：如果新的 Value 预测值 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>V</mi><mi>ϕ</mi></msub><mo>(</mo><mi>s</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">V_\phi(s)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">ϕ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mclose">)</span></span></span></span> 偏离旧值 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>V</mi><mrow><mi>o</mi><mi>l</mi><mi>d</mi></mrow></msub></mrow><annotation encoding="application/x-tex">V_{old}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 太多，我们就不完全信任这个新的预测值产生的梯度，而是用 Clip 后的值来计算 Loss。</p>
<h4 id="源码实现-2"><strong>源码实现</strong></h4>
<p>Python</p>
<pre><code>def compute_value_loss(v_pred, v_old, returns, clip_range=0.2):
    # v_pred: 当前 Critic 预测值
    # v_old: 采样时的 Critic 预测值 (Detached)
    # returns: 真实的 GAE Returns
    
    # 1. 不 Clip 的 Loss (标准 MSE)
    v_loss_unclipped = (v_pred - returns) ** 2
    
    # 2. Clip 后的预测值
    v_clipped = v_old + torch.clamp(v_pred - v_old, -clip_range, clip_range)
    
    # 3. Clip 后的 Loss
    v_loss_clipped = (v_clipped - returns) ** 2
    
    # 4. 取 Max (注意：这里我们要最小化 Loss，取 Max 是为了惩罚由于“步子太大”导致的误差)
    # 逻辑是：如果 Clip 后的误差比不 Clip 的还大，说明“步子太大”反而偏离了目标，
    # 但 PyTorch 实现通常取 max 是为了让梯度回传时考虑那个产生更大 Error 的项（悲观约束）
    v_loss = torch.max(v_loss_unclipped, v_loss_clipped).mean()
    
    # 通常乘以 0.5 (MSE 导数有个 2，为了抵消)
    return 0.5 * v_loss
</code></pre>
<hr>
<h3 id="总结如何用这些点打动面试官">总结：如何用这些点打动面试官？</h3>
<p>当面试官问你 <strong>“在实现 RLHF 时遇到过什么困难？”</strong> 时，不要只说“调参难”。你可以这样回答：</p>
<blockquote>
<p>“除了超参数调整，我发现<strong>工程实现的细节对收敛性影响巨大</strong>。</p>
<p>比如在实现 PPO Step 时，我最初发现 Loss 波动很大，后来通过 Trace 代码发现是 <strong>Advantage 没有做 Batch 级别的 Normalization</strong>，加上之后训练曲线立刻平滑了。</p>
<p>另外，针对长文本生成，我特别注意了 <strong>Masking 的处理</strong>，不仅仅是 Mask 掉 Loss，更是在计算 GAE 时要正确处理截断。</p>
<p>在数值上，我严格遵循 <strong>Log Space Operation</strong>，避免了 Ratio 计算时的下溢出问题。”</p>
</blockquote>
<p>这段话涵盖了数学直觉、Debug 经验和工程严谨性，是面试官最想听到的答案。</p>
</blockquote>
<hr>
<h3 id="4-面试高频考察点-interview-checkpoints">4. 面试高频考察点 (Interview Checkpoints)</h3>
<p>以下是针对 <code>step</code> 函数的高频追问：</p>
<h4 id="q1-为什么计算-ratio-时要用-expnew_log-old_log-而不是直接-new_prob-old_prob"><strong>Q1: 为什么计算 Ratio 时要用 <code>exp(new_log - old_log)</code> 而不是直接 <code>new_prob / old_prob</code>？</strong></h4>
<ul>
<li><strong>满分回答</strong>：主要为了<strong>数值稳定性</strong>。神经网络输出通常是 Logits，直接 Softmax 后的概率值可能非常小（下溢出），直接相除会产生巨大的数值误差。在 Log 域做减法等价于除法，且数值范围更安全，最后 exp 即可。</li>
</ul>
<h4 id="q2-在-rlhf-中rewad-model-和-critic-model-value-model-是同一个东西吗"><strong>Q2: 在 RLHF 中，Rewad Model 和 Critic Model (Value Model) 是同一个东西吗？</strong></h4>
<ul>
<li><strong>满分回答</strong>：<strong>不是</strong>。
<ul>
<li><strong>Reward Model</strong>：是环境的一部分，冻结参数不更新，负责给完整的 Response 打分。</li>
<li><strong>Critic (Value) Model</strong>：是 PPO 算法的一部分，参数会更新，负责预测每个 Token 步骤的预期收益（Value），用于计算 Advantage。</li>
<li><em>进阶</em>：为了节省显存，DeepSpeed-Chat 允许 Critic 和 Actor 共享部分 Backbone 权重（类似 Hydra Head 结构）。</li>
</ul>
</li>
</ul>
<blockquote>
<p>这是一个非常经典且极其重要的面试题。混淆 Reward Model (RM) 和 Critic Model (Value Model) 是初级候选人最常见的错误。</p>
<p>虽然它们都是“打分模型”，且架构通常都是 <code>Transformer Backbone + Scalar Head</code>，但在 <strong>RL 流程、数学定义、参数更新机制</strong> 上有本质区别。</p>
<p>我将从**功能定位、数学交互、架构优化（Hydra Head）**三个维度为你深度拆解。</p>
<hr>
<h3 id="1-核心差异对比表-the-executive-summary">1. 核心差异对比表 (The Executive Summary)</h3>
<table>
<thead>
<tr>
<th><strong>维度</strong></th>
<th><strong>Reward Model (RM)</strong></th>
<th><strong>Critic Model (Value Model)</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>角色比喻</strong></td>
<td><strong>阅卷老师</strong> (考完试给个总分)</td>
<td><strong>辅导教练</strong> (做题过程中预测能得多少分)</td>
</tr>
<tr>
<td><strong>数学定义</strong></td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>R</mi><mo>(</mo><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">R(s, a)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">a</span><span class="mclose">)</span></span></span></span> 或 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>R</mi><mo>(</mo><mtext>prompt</mtext><mo separator="true">,</mo><mtext>response</mtext><mo>)</mo></mrow><annotation encoding="application/x-tex">R(\text{prompt}, \text{response})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord text"><span class="mord">prompt</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">response</span></span><span class="mclose">)</span></span></span></span></td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>V</mi><mi>ϕ</mi></msub><mo>(</mo><msub><mi>s</mi><mi>t</mi></msub><mo>)</mo></mrow><annotation encoding="application/x-tex">V_\phi(s_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">ϕ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></td>
</tr>
<tr>
<td><strong>输入范围</strong></td>
<td>通常是完整的 Sequence (Prompt + Response)</td>
<td>每一个时间步的 State (Prompt + Partial Response)</td>
</tr>
<tr>
<td><strong>输出频率</strong></td>
<td><strong>Sparse (稀疏)</strong>：通常只在生成结束 (EOS) 时给一个标量分。</td>
<td><strong>Dense (密集)</strong>：针对每个 Token 输出一个标量 Value。</td>
</tr>
<tr>
<td><strong>训练阶段</strong></td>
<td><strong>Phase 2</strong> (Reward Modeling)，在 RLHF 开始前训好。</td>
<td><strong>Phase 3</strong> (PPO)，与 Actor 同步训练。</td>
</tr>
<tr>
<td><strong>参数状态</strong></td>
<td><strong>Frozen (冻结)</strong>：作为环境的一部分，不仅不更新，还要用于计算 KL Penalty。</td>
<td><strong>Active (更新)</strong>：通过 MSE Loss 逼近真实 Return。</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="2-深度原理解析">2. 深度原理解析</h3>
<h4 id="1-reward-model环境的代理-proxy-of-environment"><strong>(1) Reward Model：环境的代理 (Proxy of Environment)</strong></h4>
<ul>
<li><strong>本质</strong>：RM 是人类偏好（Human Preference）的数字化身。因为我们无法在训练循环中实时让人类打分，所以训练一个 RM 来模拟人类。</li>
<li><strong>工作流</strong>：
<ol>
<li>Actor 生成完整的句子。</li>
<li>RM 接收完整句子，输出一个标量 Score（例如 5.0 分）。</li>
<li><strong>注意</strong>：在 PPO 的标准实现中，RM 的分数仅加在<strong>最后一个 Token</strong> 的 Reward 上。中间 Token 的原始 Reward 通常为 0（或者只有 KL 惩罚）。</li>
</ol>
</li>
</ul>
<h4 id="2-critic-model降低方差的基准-baseline-for-variance-reduction"><strong>(2) Critic Model：降低方差的基准 (Baseline for Variance Reduction)</strong></h4>
<ul>
<li>
<p><strong>本质</strong>：Critic 的作用是估计“状态价值”（State Value）。它回答的问题是：“在这个时刻，基于前面的输入，后面大概率能得多少分？”</p>
</li>
<li>
<p><strong>为什么需要它？</strong></p>
<ul>
<li>
<p>如果只用 RM 的最终得分 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span></span></span></span> 来更新，这就退化为 REINFORCE 算法。由于文本生成的随机性，方差极大（同样的好开头可能因为结尾烂了而得低分）。</p>
</li>
<li>
<p><strong>Advantage Function (优势函数)</strong> 的引入：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi><mo>(</mo><msub><mi>s</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>a</mi><mi>t</mi></msub><mo>)</mo><mo>=</mo><mi>Q</mi><mo>(</mo><msub><mi>s</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>a</mi><mi>t</mi></msub><mo>)</mo><mo>−</mo><mi>V</mi><mo>(</mo><msub><mi>s</mi><mi>t</mi></msub><mo>)</mo><mo>≈</mo><mo>(</mo><msub><mi>r</mi><mi>t</mi></msub><mo>+</mo><mi>γ</mi><mi>V</mi><mo>(</mo><msub><mi>s</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>)</mo><mo>)</mo><mo>−</mo><mi>V</mi><mo>(</mo><msub><mi>s</mi><mi>t</mi></msub><mo>)</mo></mrow><annotation encoding="application/x-tex">A(s_t, a_t) = Q(s_t, a_t) - V(s_t) \approx (r_t + \gamma V(s_{t+1})) - V(s_t)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">A</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.05556em;">γ</span><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.301108em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p>这里 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>V</mi><mo>(</mo><msub><mi>s</mi><mi>t</mi></msub><mo>)</mo></mrow><annotation encoding="application/x-tex">V(s_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 就是 Critic 的输出。它作为一个 Baseline，告诉 Actor：“你这一步做得比‘平均预期’好，还是差？”</p>
</li>
</ul>
</li>
<li>
<p><strong>工作流</strong>：</p>
<ol>
<li>Sequence 中的每一个 Token <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathdefault">t</span></span></span></span>，Critic 都会输出一个预测值 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>V</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">V_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>。</li>
<li>PPO 使用 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>V</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">V_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>V</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">V_{t+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.891661em;vertical-align:-0.208331em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.301108em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span></span></span></span> 以及实际 Reward 计算 <strong>TD Error</strong> (Temporal Difference)，进而计算 GAE。</li>
</ol>
</li>
</ul>
<hr>
<h3 id="3-数据流向图解-data-flow-in-ppo-step">3. 数据流向图解 (Data Flow in PPO Step)</h3>
<p>这是面试白板画图的重点，展示你对“数据怎么流转”的一清二楚。</p>
<ol>
<li><strong>Rollout 阶段</strong>：
<ul>
<li>Actor 生成文本 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span></span>。</li>
<li><strong>Reward Model</strong> 计算最终得分 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>R</mi><mrow><mi>f</mi><mi>i</mi><mi>n</mi><mi>a</mi><mi>l</mi></mrow></msub></mrow><annotation encoding="application/x-tex">R_{final}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.10764em;">f</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>。</li>
<li><strong>Critic Model</strong> 预测每个 Token 的价值 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>V</mi><mrow><mn>0...</mn><mi>T</mi></mrow></msub></mrow><annotation encoding="application/x-tex">V_{0...T}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mord mtight">.</span><span class="mord mtight">.</span><span class="mord mtight">.</span><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>。</li>
</ul>
</li>
<li><strong>计算 Advantage</strong>：
<ul>
<li>构造 Reward 序列：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>r</mi><mi>t</mi></msub><mo>=</mo><mo>−</mo><mi>β</mi><mi>log</mi><mo>⁡</mo><mo>(</mo><mi>π</mi><mi mathvariant="normal">/</mi><msub><mi>π</mi><mrow><mi>r</mi><mi>e</mi><mi>f</mi></mrow></msub><mo>)</mo></mrow><annotation encoding="application/x-tex">r_t = -\beta \log(\pi/\pi_{ref})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord">−</span><span class="mord mathdefault" style="margin-right:0.05278em;">β</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="mord">/</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.10764em;">f</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> (KL)，且 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>r</mi><mi>T</mi></msub><mo>+</mo><mo>=</mo><msub><mi>R</mi><mrow><mi>f</mi><mi>i</mi><mi>n</mi><mi>a</mi><mi>l</mi></mrow></msub></mrow><annotation encoding="application/x-tex">r_T += R_{final}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.73333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">+</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.10764em;">f</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>。</li>
<li>使用 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>r</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">r_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>V</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">V_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 计算 Advantage <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mover accent="true"><mi>A</mi><mo>^</mo></mover><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">\hat{A}_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0967699999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9467699999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.11110999999999999em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>。</li>
</ul>
</li>
<li><strong>Update 阶段</strong>：
<ul>
<li><strong>Critic Loss</strong>：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>L</mi><mrow><mi>V</mi><mi>F</mi></mrow></msub><mo>=</mo><mo>(</mo><msub><mi>V</mi><mrow><mi>n</mi><mi>e</mi><mi>w</mi></mrow></msub><mo>(</mo><msub><mi>s</mi><mi>t</mi></msub><mo>)</mo><mo>−</mo><mo>(</mo><msub><mi>A</mi><mi>t</mi></msub><mo>+</mo><msub><mi>V</mi><mrow><mi>o</mi><mi>l</mi><mi>d</mi></mrow></msub><mo>(</mo><msub><mi>s</mi><mi>t</mi></msub><mo>)</mo><mo>)</mo><msup><mo>)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">L_{VF} = (V_{new}(s_t) - (A_t + V_{old}(s_t)))^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.22222em;">V</span><span class="mord mathdefault mtight" style="margin-right:0.13889em;">F</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">)</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span>。Critic 拼命去拟合“真实的预期收益”。</li>
<li><strong>Actor Loss</strong>：使用 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mover accent="true"><mi>A</mi><mo>^</mo></mover><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">\hat{A}_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0967699999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9467699999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.11110999999999999em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 更新概率分布。</li>
</ul>
</li>
</ol>
<hr>
<h3 id="4-进阶deepspeed-chat-的-hydra-head-混合引擎架构">4. 进阶：DeepSpeed-Chat 的 Hydra Head (混合引擎架构)</h3>
<p>这就是你提到的“共享权重”机制，是解决显存瓶颈的工业级方案。</p>
<h4 id="痛点显存爆炸"><strong>痛点：显存爆炸</strong></h4>
<p>在标准 PPO 中，我们需要内存中同时存在 4 个模型：</p>
<ol>
<li><strong>Actor</strong> (Policy) - Trainable</li>
<li><strong>Critic</strong> (Value) - Trainable</li>
<li><strong>Reference</strong> (SFT Model) - Frozen (用于算 KL)</li>
<li><strong>Reward Model</strong> - Frozen (用于给分)</li>
</ol>
<p>如果是 70B 的模型，加载 4 份权重是不可接受的（显存 x4）。</p>
<h4 id="解决方案lora-hydra-head"><strong>解决方案：LoRA + Hydra Head</strong></h4>
<p>DeepSpeed 和现代 RLHF 框架（如 LLaMA-Factory）通常采用以下优化：</p>
<ol>
<li><strong>共享 Backbone</strong>：Actor 和 Critic 本质上都是在“理解语言”。它们的前 N-1 层 Transformer Layer 是一样的，区别只在于最后一层。
<ul>
<li>Actor Head: <code>Linear(hidden_size, vocab_size)</code></li>
<li>Critic Head: <code>Linear(hidden_size, 1)</code></li>
</ul>
</li>
<li><strong>LoRA 分离</strong>：
<ul>
<li>加载一个 Frozen 的 Base Model。</li>
<li><strong>Actor</strong> 是一个 LoRA Adapter。</li>
<li><strong>Critic</strong> 是另一个 LoRA Adapter (或者直接共用 Backbone，只分叉 Head)。</li>
<li><strong>Reference</strong> 不需要加载额外模型，直接禁用 Actor LoRA 进行前向传播即可获得。</li>
<li><strong>Reward Model</strong> 往往也可以卸载（Offload）到 CPU，只在最后算分时传回 GPU，或者也做成一个 LoRA。</li>
</ul>
</li>
</ol>
<h4 id="hydra-head-示意代码-conceptual-pytorch"><strong>Hydra Head 示意代码 (Conceptual PyTorch)</strong></h4>
<p>Python</p>
<pre><code>class HydraModel(nn.Module):
    def __init__(self, base_model):
        super().__init__()
        self.base_model = base_model # 共享的大模型底座 (如 Llama-7B)
        
        # 两个不同的头
        self.actor_head = nn.Linear(4096, 32000, bias=False) # 输出 Logits
        self.critic_head = nn.Linear(4096, 1)    # 输出 Scalar Value
        
    def forward(self, input_ids):
        # 1. 经过共享的 Backbone
        # hidden_states: [batch, seq_len, 4096]
        outputs = self.base_model(input_ids, output_hidden_states=True)
        last_hidden_state = outputs.hidden_states[-1]
        
        # 2. 分叉
        logits = self.actor_head(last_hidden_state) # -&gt; Policy
        values = self.critic_head(last_hidden_state) # -&gt; Value
        
        return logits, values
</code></pre>
<h4 id="面试满分细节共享权重的副作用"><strong>面试满分细节：共享权重的副作用</strong></h4>
<p>面试官可能会追问：“共享权重有什么坏处？”</p>
<ul>
<li><strong>回答</strong>：这属于 <strong>Multi-task Learning</strong>。Actor 想要最大化 Reward，Critic 想要最小化 MSE。两者的梯度方向可能冲突（Gradient Conflict），导致 Backbone 难以收敛。</li>
<li><strong>解决</strong>：
<ul>
<li>通常在 Critic Loss 上加较小的系数（如 0.5）。</li>
<li>或者在 DeepSpeed 中，Critic 和 Actor 在训练初期共享，但在微调后期可能会解耦（或者使用 LoRA 使得 Backbone 冻结，只更新 Adapter，从而避免了 Backbone 的破坏）。</li>
</ul>
</li>
</ul>
<h3 id="总结">总结</h3>
<p>Reward Model 是<strong>裁判</strong>（定性的），Critic Model 是<strong>私教</strong>（定量的）。在工程实现上，为了省钱（显存），我们可以让裁判和私教共用一个身体（Backbone），只换不同的帽子（Head），这就是 <strong>Hydra Head</strong> 架构。</p>
</blockquote>
<h4 id="q3-为什么要有-kl-divergence-penalty代码里体现在哪里"><strong>Q3: 为什么要有 KL Divergence Penalty？代码里体现在哪里？</strong></h4>
<ul>
<li>
<p><strong>满分回答</strong>：为了防止 <strong>Reward Hacking</strong>（模型为了高分输出不可读的文本）以及保持与 SFT 模型的分布一致性（避免灾难性遗忘）。</p>
</li>
<li>
<p><em>代码体现</em>：在 <code>trl</code> 中，KL 散度通常被<strong>作为负的 Reward 项</strong>直接加在 Reward Model 的打分上：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>R</mi><mrow><mi>t</mi><mi>o</mi><mi>t</mi><mi>a</mi><mi>l</mi></mrow></msub><mo>=</mo><msub><mi>R</mi><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi></mrow></msub><mo>−</mo><mi>β</mi><mi>log</mi><mo>⁡</mo><mo>(</mo><mfrac><mrow><msub><mi>π</mi><mrow><mi>R</mi><mi>L</mi></mrow></msub><mo>(</mo><mi>x</mi><mo>)</mo></mrow><mrow><msub><mi>π</mi><mrow><mi>R</mi><mi>e</mi><mi>f</mi></mrow></msub><mo>(</mo><mi>x</mi><mo>)</mo></mrow></mfrac><mo>)</mo></mrow><annotation encoding="application/x-tex">R_{total} = R_{model} - \beta \log(\frac{\pi_{RL}(x)}{\pi_{Ref}(x)})
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">m</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">d</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.399108em;vertical-align:-0.972108em;"></span><span class="mord mathdefault" style="margin-right:0.05278em;">β</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.00773em;">R</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.10764em;">f</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.00773em;">R</span><span class="mord mathdefault mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.972108em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span></span></span></span></span></p>
<p>这样在计算 GAE 时，Advantage 就已经包含了 KL 的约束，<code>step</code> 函数不需要显式写 KL Loss 项。</p>
</li>
</ul>
<h4 id="q4-ppo-是-on-policy-还是-off-policy这对数据加载有什么影响"><strong>Q4: PPO 是 On-Policy 还是 Off-Policy？这对数据加载有什么影响？</strong></h4>
<ul>
<li><strong>满分回答</strong>：<strong>On-Policy</strong>。这意味着我们用于更新参数的数据（Experience）必须是当前策略（Current Policy）生成的。</li>
<li><em>影响</em>：每次 <code>step</code> 更新完参数后，之前生成的 Rollout 数据就“过期”了，必须丢弃。这就是 PPO 训练慢的主要原因（采样效率低）。</li>
</ul>
<hr>
<h3 id="5-场景与演进-sota-evolution">5. 场景与演进 (SOTA &amp; Evolution)</h3>
<h4 id="业务场景"><strong>业务场景</strong></h4>
<ul>
<li><strong>LLM Alignment</strong>：ChatGPT, Claude, Llama 2/3 的 RLHF 阶段，用于让模型对齐人类价值观（Helpful, Honest, Harmless）。</li>
<li><strong>Code Generation</strong>：优化代码通过率（Unit Test Pass Rate）作为 Reward。</li>
</ul>
<h4 id="sota-演进ppo-的替代者"><strong>SOTA 演进：PPO 的替代者</strong></h4>
<p>虽然 PPO 是目前的工业界标准（Baselines），但因其训练极其复杂（需要加载 Actor, Critic, Ref, Reward 四个模型），业界正在向 <strong>Reward-Free / Direct Alignment</strong> 方法演进：</p>
<ol>
<li><strong>DPO (Direct Preference Optimization, NeurIPS 2023)</strong>：
<ul>
<li><strong>改进</strong>：推导出最优 Policy 的解析解，将 RL 问题转化为二分类问题（Classification Loss）。<strong>不需要 Critic 模型，不需要 PPO 采样循环</strong>。</li>
<li><em>本质</em>：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>L</mi><mrow><mi>D</mi><mi>P</mi><mi>O</mi></mrow></msub><mo>=</mo><mo>−</mo><mi>log</mi><mo>⁡</mo><mi>σ</mi><mo>(</mo><mi>β</mi><mi>log</mi><mo>⁡</mo><mfrac><msub><mi>π</mi><mrow><mi>w</mi><mi>i</mi><mi>n</mi></mrow></msub><msub><mi>π</mi><mrow><mi>r</mi><mi>e</mi><mi>f</mi></mrow></msub></mfrac><mo>−</mo><mi>β</mi><mi>log</mi><mo>⁡</mo><mfrac><msub><mi>π</mi><mrow><mi>l</mi><mi>o</mi><mi>s</mi><mi>e</mi></mrow></msub><msub><mi>π</mi><mrow><mi>r</mi><mi>e</mi><mi>f</mi></mrow></msub></mfrac><mo>)</mo></mrow><annotation encoding="application/x-tex">L_{DPO} = - \log \sigma (\beta \log \frac{\pi_{win}}{\pi_{ref}} - \beta \log \frac{\pi_{lose}}{\pi_{ref}})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">D</span><span class="mord mathdefault mtight" style="margin-right:0.13889em;">P</span><span class="mord mathdefault mtight" style="margin-right:0.02778em;">O</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.29808em;vertical-align:-0.5480799999999999em;"></span><span class="mord">−</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.05278em;">β</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7114919999999999em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.10764em;">f</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29011428571428566em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.4101em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.02691em;">w</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5480799999999999em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.29808em;vertical-align:-0.5480799999999999em;"></span><span class="mord mathdefault" style="margin-right:0.05278em;">β</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.717252em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.10764em;">f</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29011428571428566em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.41586em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5480799999999999em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span></span></span></span>。</li>
</ul>
</li>
<li><strong>IPO (Identity Policy Optimization)</strong>：解决了 DPO 容易过拟合的问题，在目标函数中增加了正则化。</li>
<li><strong>KTO (Kahneman-Tversky Optimization)</strong>：不需要成对偏好数据（Pairwise），只需要二元信号（Good/Bad），数据效率更高。</li>
</ol>
<p><strong>面试总结句</strong>：“虽然 DPO 等方法在学术界和部分场景下表现优异且训练更稳，但在处理极度复杂的推理任务或需要细粒度 Token 级 Reward 时，PPO 依然是上限更高、调优空间更大的选择（如 OpenAI 目前仍在坚持使用 PPO 变体）。”</p>
<blockquote>
<p>这是一个非常深刻且直击当前大模型前沿（Frontier Model）核心痛点的论断。在面试中，能把这一点讲透，直接证明你具备<strong>AGI 视角</strong>而不仅仅是<strong>SFT 视角</strong>。</p>
<p>这句话的核心在于揭示了 <strong>DPO（及其变体）与 PPO 在“学习范式”上的本质区别</strong>。</p>
<p>为了让你在面试中“降维打击”，我们将从 <strong>探索能力（Exploration）</strong>、<strong>信用分配（Credit Assignment）</strong> 和 <strong>奖励粒度（Granularity）</strong> 三个硬核维度进行深度解析。</p>
<hr>
<h3 id="1-探索机制静态数据-vs-动态博弈-static-data-vs-dynamic-game">1. 探索机制：静态数据 vs. 动态博弈 (Static Data vs. Dynamic Game)</h3>
<p>这是两者最根本的区别，决定了模型能力的<strong>天花板</strong>。</p>
<h4 id="dpo-的局限受限于数据集分布-in-distribution-constraint"><strong>DPO 的局限：受限于数据集分布 (In-Distribution Constraint)</strong></h4>
<ul>
<li><strong>本质</strong>：DPO 是 <strong>Offline</strong> 算法。它直接在一个固定的偏好数据集 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>(</mo><mi>x</mi><mo separator="true">,</mo><msub><mi>y</mi><mi>w</mi></msub><mo separator="true">,</mo><msub><mi>y</mi><mi>l</mi></msub><mo>)</mo></mrow><annotation encoding="application/x-tex">(x, y_w, y_l)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 上优化。</li>
<li><strong>痛点</strong>：DPO 实际上是在做“最大似然估计”的一种变体。模型学到的策略 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>π</mi><mrow><mi>D</mi><mi>P</mi><mi>O</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\pi_{DPO}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">D</span><span class="mord mathdefault mtight" style="margin-right:0.13889em;">P</span><span class="mord mathdefault mtight" style="margin-right:0.02778em;">O</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 很难跳出数据集中 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>y</mi><mi>w</mi></msub></mrow><annotation encoding="application/x-tex">y_w</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>（胜者）所覆盖的解空间。</li>
<li><strong>后果</strong>：如果你的 Preference Data 只有“中等水平”的回答，DPO 很难无中生有地学会“高等水平”的策略。<strong>它是在模仿好坏，而不是探索未知。</strong></li>
</ul>
<h4 id="ppo-的优势on-policy-的探索能力-exploration"><strong>PPO 的优势：On-Policy 的探索能力 (Exploration)</strong></h4>
<ul>
<li><strong>本质</strong>：PPO 是 <strong>On-Policy</strong> 算法。Actor 在训练过程中会不断采样生成<strong>新的</strong> Response（Generate Rollout）。</li>
<li><strong>优势</strong>：模型会尝试一些它以前没见过的路径。
<ul>
<li>如果它偶然生成了一个比 Dataset 中更好的解，Reward Model 会给高分，模型就会强化这个新路径。</li>
<li><strong>这就像 AlphaGo</strong>：AlphaGo 不是通过背棋谱（Supervised Learning）战胜人类的，而是通过左右互搏（RL）探索出了人类未曾发现的“神之一手”。</li>
</ul>
</li>
<li><strong>结论</strong>：对于逻辑推理（Math/Code），解空间巨大且非平滑。PPO 允许模型在训练中“试错”，从而发现比 SFT 数据更优的解法。</li>
</ul>
<hr>
<h3 id="2-奖励粒度结果奖励-vs-过程奖励-outcome-vs-process">2. 奖励粒度：结果奖励 vs. 过程奖励 (Outcome vs. Process)</h3>
<p>这是 OpenAI <strong>o1 (Strawberry)</strong> 等推理模型背后的核心技术，也是 DPO 目前最大的短板。</p>
<h4 id="dpo-的短板只能处理-outcome-reward-orm"><strong>DPO 的短板：只能处理 Outcome Reward (ORM)</strong></h4>
<ul>
<li><strong>机制</strong>：DPO 的 Loss 函数基于成对比较 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>−</mo><mi>log</mi><mo>⁡</mo><mi>σ</mi><mo>(</mo><mi>β</mi><mi>log</mi><mo>⁡</mo><mfrac><mrow><mi>π</mi><mo>(</mo><msub><mi>y</mi><mi>w</mi></msub><mo>)</mo></mrow><mrow><msub><mi>π</mi><mrow><mi>r</mi><mi>e</mi><mi>f</mi></mrow></msub><mo>(</mo><msub><mi>y</mi><mi>w</mi></msub><mo>)</mo></mrow></mfrac><mo>−</mo><mo>…</mo><mtext> </mtext><mo>)</mo></mrow><annotation encoding="application/x-tex">-\log \sigma (\beta \log \frac{\pi(y_w)}{\pi_{ref}(y_w)} - \dots)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.55808em;vertical-align:-0.5480799999999999em;"></span><span class="mord">−</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.05278em;">β</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.01em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.10764em;">f</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29011428571428566em;"><span></span></span></span></span></span></span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285719em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.485em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">π</span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285719em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5480799999999999em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mclose">)</span></span></span></span>。这隐含地假设 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>y</mi><mi>w</mi></msub></mrow><annotation encoding="application/x-tex">y_w</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> <strong>整体</strong>优于 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>y</mi><mi>l</mi></msub></mrow><annotation encoding="application/x-tex">y_l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>。</li>
<li><strong>推理任务的灾难</strong>：
<ul>
<li>假设一道 10 步的数学题。</li>
<li>Response A（Winner）：前 9 步全对，最后一步算错了。</li>
<li>Response B（Loser）：第 1 步就错了，后面全是胡扯。</li>
<li>虽然 A 确实比 B 好，但如果直接用 DPO，模型可能会错误地认为“A 的那个错误步骤”也是好的（因为它属于 Winner）。DPO 无法区分序列中<strong>哪一步是好，哪一步是坏</strong>。</li>
</ul>
</li>
</ul>
<h4 id="ppo-的杀手锏能够结合-process-reward-model-prm"><strong>PPO 的杀手锏：能够结合 Process Reward Model (PRM)</strong></h4>
<ul>
<li><strong>机制</strong>：PPO 依赖 Value Function（Critic）。在 PPO 框架下，我们可以引入 <strong>Dense Reward（密集奖励）</strong>。</li>
<li><strong>核心论文</strong>：<a href="https://arxiv.org/abs/2305.20050">Let's Verify Step by Step (OpenAI, 2023)</a></li>
<li><strong>实现</strong>：
<ul>
<li>可以为推理链（Chain of Thought）的**每一步（Step-level）**甚至每一个 Token 打分。</li>
<li>Critic 模型 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>V</mi><mo>(</mo><msub><mi>s</mi><mi>t</mi></msub><mo>)</mo></mrow><annotation encoding="application/x-tex">V(s_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 会学习到：虽然最终答案错了，但中间到达 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>s</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">s_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 这一步的状态价值很高。</li>
<li>通过 GAE（Generalized Advantage Estimation），PPO 可以精准地进行 <strong>Credit Assignment（信用分配）</strong>：奖励逻辑正确的中间步骤，仅惩罚最后出错的那一步。</li>
</ul>
</li>
<li><strong>结论</strong>：对于复杂推理（Math, Coding, Agent Planning），必须使用 PPO + PRM 才能训练出具备长链条逻辑修正能力的模型。</li>
</ul>
<hr>
<h3 id="3-分布偏移与自我修正-distribution-shift-self-correction">3. 分布偏移与自我修正 (Distribution Shift &amp; Self-Correction)</h3>
<h4 id="dpo-的-ood-问题"><strong>DPO 的 OOD 问题</strong></h4>
<ul>
<li>当模型在推理时，一旦产生了一个训练集中未覆盖的“微小错误”，由于 DPO 没有在训练中见过这种“自身产生的错误状态”，它往往无法 Self-Correct，导致一步错步步错（Error Accumulation）。</li>
</ul>
<h4 id="ppo-的鲁棒性"><strong>PPO 的鲁棒性</strong></h4>
<ul>
<li>PPO 在训练的 Rollout 阶段，Actor 经常会“胡言乱语”或犯错。Critic 随即会给出一个低分，PPO 算法会根据这个反馈更新梯度，告诉 Actor “如果进入这种状态，要怎么调整回来”。</li>
<li>这使得 PPO 训练出的模型在面对 Out-of-Distribution (OOD) 状态时，具有更强的<strong>鲁棒性</strong>和<strong>自我纠错能力</strong>。</li>
</ul>
<hr>
<h3 id="4-面试总结表-cheat-sheet">4. 面试总结表 (Cheat Sheet)</h3>
<p>在回答面试官时，可以用这个心理模型来组织语言：</p>
<table>
<thead>
<tr>
<th><strong>维度</strong></th>
<th><strong>DPO / IPO / KTO (Direct Alignment)</strong></th>
<th><strong>PPO (Proximal Policy Optimization)</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>适用场景</strong></td>
<td>闲聊、文案写作、风格对齐 (Chat/Creative)</td>
<td><strong>复杂逻辑推理、代码生成、多轮 Agent (Reasoning/Math)</strong></td>
</tr>
<tr>
<td><strong>数据需求</strong></td>
<td>需要高质量的成对偏好数据 (Pairwise Data)</td>
<td>只需要 Reward Signal (可以是 Rule-based 编译器、单元测试、Verifier)</td>
</tr>
<tr>
<td><strong>奖励粒度</strong></td>
<td><strong>Sentence-level</strong> (一棒子打死)</td>
<td><strong>Token/Step-level</strong> (精准赏罚)</td>
</tr>
<tr>
<td><strong>上限 (Ceiling)</strong></td>
<td>受限于数据质量 (Data-bound)</td>
<td><strong>受限于环境反馈 (Environment-bound)</strong> - 上限极高</td>
</tr>
<tr>
<td><strong>训练稳定性</strong></td>
<td>高 (像 SFT 一样稳)</td>
<td>低 (对超参极度敏感，容易崩)</td>
</tr>
<tr>
<td><strong>资源消耗</strong></td>
<td>低 (1个模型)</td>
<td>高 (4个模型: Actor, Critic, Ref, RM)</td>
</tr>
</tbody>
</table>
<h3 id="5-满分回答话术范例">5. 满分回答话术范例</h3>
<blockquote>
<p>“虽然 DPO 去掉了 Reward Model 显式建模的过程，极大地简化了流程并在 Chat 类任务上通过了‘图灵测试’。</p>
<p>但是，在 OpenAI o1 或 Code 生成这种<strong>客观对错分明</strong>且<strong>步骤严密</strong>的任务中，PPO 依然是不可替代的。</p>
<p>核心原因在于 <strong>Credit Assignment（信用分配）</strong>。对于一个 50 行的代码，DPO 只能告诉模型‘这坨代码是对的’。而 PPO 配合 <strong>Token-level Value Head</strong> 或 <strong>Process Reward Model (PRM)</strong>，可以告诉模型‘第 5 行定义的函数是极好的，但第 12 行的循环条件写错了’。</p>
<p>这种细粒度的反馈信号，结合 PPO On-Policy 的探索机制，允许模型在训练中通过尝试不同的解题路径来突破 SFT 数据的能力边界。这就是为什么在追求 AGI 推理能力的今天，PPO 依然是‘皇冠上的明珠’。”</p>
</blockquote>
</blockquote>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li>
<ul>
<li>
<ul>
<li><a href="#1-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%AE%BA%E6%96%87%E6%BA%AF%E6%BA%90-concept-paper-roots">1. 核心概念与论文溯源 (Concept &amp; Paper Roots)</a>
<ul>
<li><a href="#%E8%AE%BA%E6%96%87%E5%BC%95%E7%94%A8"><strong>论文引用</strong></a></li>
<li><a href="#%E6%9C%AC%E8%B4%A8%E6%A6%82%E6%8B%AC"><strong>本质概括</strong></a></li>
<li><a href="#%E7%97%9B%E7%82%B9%E8%A7%A3%E5%86%B3"><strong>痛点解决</strong></a></li>
</ul>
</li>
<li><a href="#2-%E6%95%B0%E5%AD%A6%E5%8E%9F%E7%90%86%E4%B8%8E%E6%8E%A8%E5%AF%BC-mathematical-underpinning">2. 数学原理与推导 (Mathematical Underpinning)</a>
<ul>
<li><a href="#%E6%A0%B8%E5%BF%83%E5%85%AC%E5%BC%8Fclipped-surrogate-objective"><strong>核心公式：Clipped Surrogate Objective</strong></a></li>
<li><a href="#rlhf-%E4%B8%AD%E7%9A%84%E6%80%BB-loss"><strong>RLHF 中的总 Loss</strong></a></li>
<li><a href="#%E6%A2%AF%E5%BA%A6%E7%9A%84%E7%9B%B4%E8%A7%89"><strong>梯度的直觉</strong></a></li>
</ul>
</li>
<li><a href="#3-%E6%89%8B%E6%92%95%E4%BB%A3%E7%A0%81%E9%87%8D%E7%82%B9%E4%B8%8E%E5%AE%9E%E7%8E%B0-whiteboard-coding-focus">3. 手撕代码重点与实现 (Whiteboard Coding Focus)</a>
<ul>
<li><a href="#%E6%A0%B8%E5%BF%83%E9%80%BB%E8%BE%91%E5%BF%85%E9%A1%BB%E6%AD%BB%E8%AE%B0%E7%A1%AC%E8%83%8C%E7%9A%84%E9%83%A8%E5%88%86"><strong>核心逻辑（必须死记硬背的部分）</strong></a></li>
<li><a href="#python-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-%E5%9F%BA%E4%BA%8E-pytorchtrl-%E9%A3%8E%E6%A0%BC"><strong>Python 代码实现 (基于 PyTorch/trl 风格)</strong></a></li>
<li><a href="#%E5%B7%A5%E7%A8%8B%E8%90%BD%E5%9C%B0%E7%BB%86%E8%8A%82-production-nuances"><strong>工程落地细节 (Production Nuances)</strong></a></li>
</ul>
</li>
<li><a href="#1-advantage-normalization-%E4%BC%98%E5%8A%BF%E5%87%BD%E6%95%B0%E6%A0%87%E5%87%86%E5%8C%96">1. Advantage Normalization (优势函数标准化)</a>
<ul>
<li><a href="#%E5%BA%95%E5%B1%82%E9%80%BB%E8%BE%91%E4%B8%8E%E7%97%9B%E7%82%B9"><strong>底层逻辑与痛点</strong></a></li>
<li><a href="#%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0-pytorch"><strong>源码实现 (PyTorch)</strong></a></li>
<li><a href="#%E5%B7%A5%E7%A8%8B%E7%BB%86%E8%8A%82"><strong>工程细节</strong></a></li>
</ul>
</li>
<li><a href="#2-masking-padding-%E5%A4%84%E7%90%86">2. Masking (Padding 处理)</a>
<ul>
<li><a href="#%E5%BA%95%E5%B1%82%E9%80%BB%E8%BE%91%E4%B8%8E%E7%97%9B%E7%82%B9-2"><strong>底层逻辑与痛点</strong></a></li>
<li><a href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-%E5%85%B3%E9%94%AE%E9%80%BB%E8%BE%91"><strong>代码实现 (关键逻辑)</strong></a></li>
<li><a href="#%E9%9D%A2%E8%AF%95%E6%B7%B1%E6%8C%96"><strong>面试深挖</strong></a></li>
</ul>
</li>
<li><a href="#3-numerical-stability-%E6%95%B0%E5%80%BC%E7%A8%B3%E5%AE%9A%E6%80%A7-log-space">3. Numerical Stability (数值稳定性 - Log Space)</a>
<ul>
<li><a href="#%E5%BA%95%E5%B1%82%E9%80%BB%E8%BE%91%E4%B8%8E%E7%97%9B%E7%82%B9-3"><strong>底层逻辑与痛点</strong></a></li>
<li><a href="#%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0"><strong>源码实现</strong></a></li>
</ul>
</li>
<li><a href="#4-value-function-clipping-critic-%E8%A3%81%E5%89%AA">4. Value Function Clipping (Critic 裁剪)</a>
<ul>
<li><a href="#%E5%BA%95%E5%B1%82%E9%80%BB%E8%BE%91%E4%B8%8E%E7%97%9B%E7%82%B9-4"><strong>底层逻辑与痛点</strong></a></li>
<li><a href="#%E6%95%B0%E5%AD%A6%E5%8E%9F%E7%90%86"><strong>数学原理</strong></a></li>
<li><a href="#%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0-2"><strong>源码实现</strong></a></li>
</ul>
</li>
<li><a href="#%E6%80%BB%E7%BB%93%E5%A6%82%E4%BD%95%E7%94%A8%E8%BF%99%E4%BA%9B%E7%82%B9%E6%89%93%E5%8A%A8%E9%9D%A2%E8%AF%95%E5%AE%98">总结：如何用这些点打动面试官？</a></li>
<li><a href="#4-%E9%9D%A2%E8%AF%95%E9%AB%98%E9%A2%91%E8%80%83%E5%AF%9F%E7%82%B9-interview-checkpoints">4. 面试高频考察点 (Interview Checkpoints)</a>
<ul>
<li><a href="#q1-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%AE%A1%E7%AE%97-ratio-%E6%97%B6%E8%A6%81%E7%94%A8-expnew_log-old_log-%E8%80%8C%E4%B8%8D%E6%98%AF%E7%9B%B4%E6%8E%A5-new_prob-old_prob"><strong>Q1: 为什么计算 Ratio 时要用 <code>exp(new_log - old_log)</code> 而不是直接 <code>new_prob / old_prob</code>？</strong></a></li>
<li><a href="#q2-%E5%9C%A8-rlhf-%E4%B8%ADrewad-model-%E5%92%8C-critic-model-value-model-%E6%98%AF%E5%90%8C%E4%B8%80%E4%B8%AA%E4%B8%9C%E8%A5%BF%E5%90%97"><strong>Q2: 在 RLHF 中，Rewad Model 和 Critic Model (Value Model) 是同一个东西吗？</strong></a></li>
</ul>
</li>
<li><a href="#1-%E6%A0%B8%E5%BF%83%E5%B7%AE%E5%BC%82%E5%AF%B9%E6%AF%94%E8%A1%A8-the-executive-summary">1. 核心差异对比表 (The Executive Summary)</a></li>
<li><a href="#2-%E6%B7%B1%E5%BA%A6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90">2. 深度原理解析</a>
<ul>
<li><a href="#1-reward-model%E7%8E%AF%E5%A2%83%E7%9A%84%E4%BB%A3%E7%90%86-proxy-of-environment"><strong>(1) Reward Model：环境的代理 (Proxy of Environment)</strong></a></li>
<li><a href="#2-critic-model%E9%99%8D%E4%BD%8E%E6%96%B9%E5%B7%AE%E7%9A%84%E5%9F%BA%E5%87%86-baseline-for-variance-reduction"><strong>(2) Critic Model：降低方差的基准 (Baseline for Variance Reduction)</strong></a></li>
</ul>
</li>
<li><a href="#3-%E6%95%B0%E6%8D%AE%E6%B5%81%E5%90%91%E5%9B%BE%E8%A7%A3-data-flow-in-ppo-step">3. 数据流向图解 (Data Flow in PPO Step)</a></li>
<li><a href="#4-%E8%BF%9B%E9%98%B6deepspeed-chat-%E7%9A%84-hydra-head-%E6%B7%B7%E5%90%88%E5%BC%95%E6%93%8E%E6%9E%B6%E6%9E%84">4. 进阶：DeepSpeed-Chat 的 Hydra Head (混合引擎架构)</a>
<ul>
<li><a href="#%E7%97%9B%E7%82%B9%E6%98%BE%E5%AD%98%E7%88%86%E7%82%B8"><strong>痛点：显存爆炸</strong></a></li>
<li><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88lora-hydra-head"><strong>解决方案：LoRA + Hydra Head</strong></a></li>
<li><a href="#hydra-head-%E7%A4%BA%E6%84%8F%E4%BB%A3%E7%A0%81-conceptual-pytorch"><strong>Hydra Head 示意代码 (Conceptual PyTorch)</strong></a></li>
<li><a href="#%E9%9D%A2%E8%AF%95%E6%BB%A1%E5%88%86%E7%BB%86%E8%8A%82%E5%85%B1%E4%BA%AB%E6%9D%83%E9%87%8D%E7%9A%84%E5%89%AF%E4%BD%9C%E7%94%A8"><strong>面试满分细节：共享权重的副作用</strong></a></li>
</ul>
</li>
<li><a href="#%E6%80%BB%E7%BB%93">总结</a>
<ul>
<li><a href="#q3-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E6%9C%89-kl-divergence-penalty%E4%BB%A3%E7%A0%81%E9%87%8C%E4%BD%93%E7%8E%B0%E5%9C%A8%E5%93%AA%E9%87%8C"><strong>Q3: 为什么要有 KL Divergence Penalty？代码里体现在哪里？</strong></a></li>
<li><a href="#q4-ppo-%E6%98%AF-on-policy-%E8%BF%98%E6%98%AF-off-policy%E8%BF%99%E5%AF%B9%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E6%9C%89%E4%BB%80%E4%B9%88%E5%BD%B1%E5%93%8D"><strong>Q4: PPO 是 On-Policy 还是 Off-Policy？这对数据加载有什么影响？</strong></a></li>
</ul>
</li>
<li><a href="#5-%E5%9C%BA%E6%99%AF%E4%B8%8E%E6%BC%94%E8%BF%9B-sota-evolution">5. 场景与演进 (SOTA &amp; Evolution)</a>
<ul>
<li><a href="#%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF"><strong>业务场景</strong></a></li>
<li><a href="#sota-%E6%BC%94%E8%BF%9Bppo-%E7%9A%84%E6%9B%BF%E4%BB%A3%E8%80%85"><strong>SOTA 演进：PPO 的替代者</strong></a></li>
</ul>
</li>
<li><a href="#1-%E6%8E%A2%E7%B4%A2%E6%9C%BA%E5%88%B6%E9%9D%99%E6%80%81%E6%95%B0%E6%8D%AE-vs-%E5%8A%A8%E6%80%81%E5%8D%9A%E5%BC%88-static-data-vs-dynamic-game">1. 探索机制：静态数据 vs. 动态博弈 (Static Data vs. Dynamic Game)</a>
<ul>
<li><a href="#dpo-%E7%9A%84%E5%B1%80%E9%99%90%E5%8F%97%E9%99%90%E4%BA%8E%E6%95%B0%E6%8D%AE%E9%9B%86%E5%88%86%E5%B8%83-in-distribution-constraint"><strong>DPO 的局限：受限于数据集分布 (In-Distribution Constraint)</strong></a></li>
<li><a href="#ppo-%E7%9A%84%E4%BC%98%E5%8A%BFon-policy-%E7%9A%84%E6%8E%A2%E7%B4%A2%E8%83%BD%E5%8A%9B-exploration"><strong>PPO 的优势：On-Policy 的探索能力 (Exploration)</strong></a></li>
</ul>
</li>
<li><a href="#2-%E5%A5%96%E5%8A%B1%E7%B2%92%E5%BA%A6%E7%BB%93%E6%9E%9C%E5%A5%96%E5%8A%B1-vs-%E8%BF%87%E7%A8%8B%E5%A5%96%E5%8A%B1-outcome-vs-process">2. 奖励粒度：结果奖励 vs. 过程奖励 (Outcome vs. Process)</a>
<ul>
<li><a href="#dpo-%E7%9A%84%E7%9F%AD%E6%9D%BF%E5%8F%AA%E8%83%BD%E5%A4%84%E7%90%86-outcome-reward-orm"><strong>DPO 的短板：只能处理 Outcome Reward (ORM)</strong></a></li>
<li><a href="#ppo-%E7%9A%84%E6%9D%80%E6%89%8B%E9%94%8F%E8%83%BD%E5%A4%9F%E7%BB%93%E5%90%88-process-reward-model-prm"><strong>PPO 的杀手锏：能够结合 Process Reward Model (PRM)</strong></a></li>
</ul>
</li>
<li><a href="#3-%E5%88%86%E5%B8%83%E5%81%8F%E7%A7%BB%E4%B8%8E%E8%87%AA%E6%88%91%E4%BF%AE%E6%AD%A3-distribution-shift-self-correction">3. 分布偏移与自我修正 (Distribution Shift &amp; Self-Correction)</a>
<ul>
<li><a href="#dpo-%E7%9A%84-ood-%E9%97%AE%E9%A2%98"><strong>DPO 的 OOD 问题</strong></a></li>
<li><a href="#ppo-%E7%9A%84%E9%B2%81%E6%A3%92%E6%80%A7"><strong>PPO 的鲁棒性</strong></a></li>
</ul>
</li>
<li><a href="#4-%E9%9D%A2%E8%AF%95%E6%80%BB%E7%BB%93%E8%A1%A8-cheat-sheet">4. 面试总结表 (Cheat Sheet)</a></li>
<li><a href="#5-%E6%BB%A1%E5%88%86%E5%9B%9E%E7%AD%94%E8%AF%9D%E6%9C%AF%E8%8C%83%E4%BE%8B">5. 满分回答话术范例</a></li>
</ul>
</li>
</ul>
</li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">下一篇</div>
            <a href="https://Alive-mk.github.io/post/dpo-direct-preference-optimization/">
              <h3 class="post-title">
                 DPO (Direct Preference Optimization)
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
  <a class="rss" href="https://Alive-mk.github.io/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
